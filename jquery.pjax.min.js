/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.6.0
 * @updated 2013/04/03
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @CodingConventions Google JavaScript Style Guide
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;function a(l){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var f={gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false},wait:0,fallback:true},e=jQuery.extend(true,{},f,l);jQuery.extend(true,e,{nss:{click:["click",e.gns+(e.ns===undefined?"":":"+e.ns)].join("."),submit:["submit",e.gns+(e.ns===undefined?"":":"+e.ns)].join("."),popstate:["popstate",e.gns+(e.ns===undefined?"":":"+e.ns)].join("."),data:e.gns+(e.ns===undefined?"":"."+e.ns),requestHeader:["X",e.gns.replace(/^(\w)/,function(m){return m.toUpperCase()})].join("-")}});if(!c()){return this}j(this,e);function c(){if(!k()){return false}if(!jQuery(e.area).length){return false}return true}function k(){return"pushState" in window.history&&window.history.pushState!==null}function j(m,n){DELEGATE_CLICK:{if(n.link===undefined){break DELEGATE_CLICK}if(n.form!==undefined){break DELEGATE_CLICK}jQuery(m).undelegate(n.link,n.nss.click).delegate(n.link,n.nss.click,n,function(o){if(o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}if(location.pathname+location.search+location.hash===this.pathname+this.search+this.hash){o.preventDefault();return this}i(this,o,this.href,true,o.data)})}DELEGATE_SUBMIT:{if(n.form===undefined){break DELEGATE_SUBMIT}jQuery(m).undelegate(n.form,n.nss.submit).delegate(n.form,n.nss.submit,n,function(o){i(this,o,jQuery(o.target).attr("action"),true,o.data)})}BIND_POPSTATE:{setTimeout(function(){jQuery(window).unbind(n.nss.popstate).bind(n.nss.popstate,n,function(o){i(this,o,location.href,false,o.data)})},100)}}function i(o,m,n,B,q){var t,y,A,p,u,x,w=[],r=[],v={dataFilter:function(E,D){t=E;y=D;return d(q.callbacks.ajax.dataFilter,o,[m,q.parameter,t,y])},complete:function(E,D){A=E;p=D;d(q.callbacks.ajax.complete,o,[m,q.parameter,A,p])}};for(var s in v){if(s in q.callbacks.ajax){continue}delete v[s]}POPSTATE:{if(m.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{w=n.match(/\?[^\s]*/);if(w===null||w[0]==="?"){break GET}q.ajax.type="GET"}delete q.ajax.data}SUBMIT:{if(m.type.toLowerCase()!=="submit"){break SUBMIT}n=n.replace(/\?[^\s]*/,"");q.ajax.type=jQuery(m.target).attr("method").toUpperCase();GET:{if(q.ajax.type!=="GET"){break GET}n+="?"+jQuery(m.target).serialize();delete q.ajax.data}POST:{if(q.ajax.type!=="POST"){break POST}q.ajax.data=jQuery(m.target).serializeArray()}}if(d(q.callbacks.before,o,[m,q.parameter])===false){return o}switch(jQuery().jquery){case"1.0":case"1.0.4":case"1.1.0":case"1.1.2":case"1.1.3":case"1.1.4":case"1.2":case"1.2.3":case"1.2.6":case"1.3":case"1.4":case"1.4.1":case"1.4.2":case"1.4.3":case"1.4.4":C();break;case"1.5":case"1.5.1":case"1.5.2":case"1.6":case"1.6.1":case"1.6.2":case"1.6.3":case"1.6.4":case"1.7":case"1.7.1":case"1.7.2":case"1.8":case"1.8.1":case"1.8.2":case"1.8.3":case"1.9":case"1.9.1":default:z();break}if(d(q.callbacks.after,o,[m,q.parameter])===false){return o}m.preventDefault();function z(){jQuery.when(g(q.wait),jQuery.ajax(jQuery.extend(true,{},q.ajax,v,{url:n,beforeSend:function(D){A=D;A.setRequestHeader(q.nss.requestHeader,"true");A.setRequestHeader(q.nss.requestHeader+"-Area",q.area);A.setRequestHeader(q.nss.requestHeader+"-CSS",q.load.css);A.setRequestHeader(q.nss.requestHeader+"-Script",q.load.script);d(q.callbacks.ajax.beforeSend,o,[m,q.parameter,A])},success:function(F,E,D){t=F;y=E;A=D;d(q.callbacks.ajax.success,o,[m,q.parameter,t,y,A])},error:function(F,E,D){A=F;p=E;u=D;d(q.callbacks.ajax.error,o,[m,q.parameter,A,p,u]);q.fallback?h(o,true):null}}))).done(function(){UPDATE:{if(d(q.callbacks.update.before,o,[m,q.parameter,t,y,A])===false){break UPDATE}try{if(A.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var M=jQuery(t).filter("title").text(),K=jQuery(t).filter('link[rel="stylesheet"], style'),L=jQuery(t).filter("script"),D=q.area.split(","),O=q.scrollLeft===null?jQuery(window).scrollLeft():parseInt(q.scrollLeft),N=q.scrollTop===null?jQuery(window).scrollTop():parseInt(q.scrollTop),H=jQuery(q.area).length,G=jQuery(q.area,t).add(jQuery(t).filter(q.area)).length;if(H===0||H!==G){throw new Error()}UPDATE_URL:{if(d(q.callbacks.update.url.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_URL}B?history.pushState(null,window.opera||("userAgent" in window&&userAgent.indexOf("opera")!==-1)?M:document.title,n):null;if(d(q.callbacks.update.url.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_TITLE:{if(d(q.callbacks.update.title.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_TITLE}document.title=M;if(d(q.callbacks.update.title.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_CONTENT:{if(d(q.callbacks.update.content.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_CONTENT}for(var J=0,E;E=D[J];J++){jQuery(E).html(jQuery(E,t).add(jQuery(t).filter(E)).html())}if(d(q.callbacks.update.content.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_CSS:{if(!q.load.css){break UPDATE_CSS}if(d(q.callbacks.update.css.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return !jQuery.data(this,q.nss.data,true)});for(var J=0,I;I=K[J];J++){if(jQuery('link[rel="stylesheet"]').filter(function(){if(this.href===I.href){jQuery.data(this,q.nss.data)?jQuery.data(this,q.nss.data,false):null;return true}return false}).length){continue}if(jQuery("style").filter(function(){if(this.innerHTML.replace(/^\s+|\s+$|\n/gm,"")===K[J].innerHTML.replace(/^\s+|\s+$|\n/gm,"")){jQuery.data(this,q.nss.data)?jQuery.data(this,q.nss.data,false):null;return true}return false}).length){continue}jQuery.data(jQuery("head").append(jQuery(K[J].outerHTML)).children(":last-child").get(0),q.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,q.nss.data)}).remove();if(d(q.callbacks.update.css.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_SCRIPT:{if(!q.load.script){break UPDATE_SCRIPT}if(d(q.callbacks.update.script.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_SCRIPT}for(var J=0,I;I=L[J];J++){if(jQuery("script[src]").filter(function(){if(this.src===I.src){return true}return false}).length){continue}jQuery.data(jQuery("head").append(jQuery(L[J].outerHTML)).children(":last-child").get(0),q.nss.data,false)}if(d(q.callbacks.update.script.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}B&&m.type==="click"?window.scrollTo(O,N):null;if(d(q.callbacks.update.success,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callbacks.update.complete,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callback,o,[m,q.parameter,t,y,A])===false){break UPDATE}}catch(F){if(d(q.callbacks.update.error,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callbacks.update.complete,o,[m,q.parameter,t,y,A])===false){break UPDATE}q.fallback?h(o,false):null}if(d(q.callbacks.update.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}}).fail().always()}function C(){jQuery.ajax(jQuery.extend(true,{},q.ajax,v,{url:n,beforeSend:function(D){A=D;A.setRequestHeader(q.nss.requestHeader,"true");A.setRequestHeader(q.nss.requestHeader+"-Area",q.area);A.setRequestHeader(q.nss.requestHeader+"-CSS",q.load.css);A.setRequestHeader(q.nss.requestHeader+"-Script",q.load.script);d(q.callbacks.ajax.beforeSend,o,[m,q.parameter,A])},success:function(N,L,K){t=N;y=L;A=K;d(q.callbacks.ajax.success,o,[m,q.parameter,t,y,A]);UPDATE:{if(d(q.callbacks.update.before,o,[m,q.parameter,t,y,A])===false){break UPDATE}try{if(A.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var P=jQuery(t).filter("title").text(),M=jQuery(t).filter('link[rel="stylesheet"], style'),O=jQuery(t).filter("script"),D=q.area.split(","),R=q.scrollLeft===null?jQuery(window).scrollLeft():parseInt(q.scrollLeft),Q=q.scrollTop===null?jQuery(window).scrollTop():parseInt(q.scrollTop),H=jQuery(q.area).length,G=jQuery(q.area,t).add(jQuery(t).filter(q.area)).length;if(H===0||H!==G){throw new Error()}UPDATE_URL:{if(d(q.callbacks.update.url.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_URL}B?history.pushState(null,window.opera||("userAgent" in window&&userAgent.indexOf("opera")!==-1)?P:document.title,n):null;if(d(q.callbacks.update.url.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_TITLE:{if(d(q.callbacks.update.title.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_TITLE}document.title=P;if(d(q.callbacks.update.title.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_CONTENT:{if(d(q.callbacks.update.content.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_CONTENT}for(var J=0,E;E=D[J];J++){jQuery(E).html(jQuery(E,t).add(jQuery(t).filter(E)).html())}if(d(q.callbacks.update.content.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_CSS:{if(!q.load.css){break UPDATE_CSS}if(d(q.callbacks.update.css.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return !jQuery.data(this,q.nss.data,true)});for(var J=0,I;I=M[J];J++){if(jQuery('link[rel="stylesheet"]').filter(function(){if(this.href===I.href){jQuery.data(this,q.nss.data)?jQuery.data(this,q.nss.data,false):null;return true}return false}).length){continue}if(jQuery("style").filter(function(){if(this.innerHTML.replace(/^\s+|\s+$|\n/gm,"")===M[J].innerHTML.replace(/^\s+|\s+$|\n/gm,"")){jQuery.data(this,q.nss.data)?jQuery.data(this,q.nss.data,false):null;return true}return false}).length){continue}jQuery.data(jQuery("head").append(jQuery(M[J].outerHTML)).children(":last-child").get(0),q.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,q.nss.data)}).remove();if(d(q.callbacks.update.css.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}UPDATE_SCRIPT:{if(!q.load.script){break UPDATE_SCRIPT}if(d(q.callbacks.update.script.before,o,[m,q.parameter,t,y,A])===false){break UPDATE_SCRIPT}for(var J=0,I;I=O[J];J++){if(jQuery("script[src]").filter(function(){if(this.src===I.src){return true}return false}).length){continue}jQuery.data(jQuery("head").append(jQuery(O[J].outerHTML)).children(":last-child").get(0),q.nss.data,false)}if(d(q.callbacks.update.script.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}B&&m.type==="click"?window.scrollTo(R,Q):null;if(d(q.callbacks.update.success,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callbacks.update.complete,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callback,o,[m,q.parameter,t,y,A])===false){break UPDATE}}catch(F){if(d(q.callbacks.update.error,o,[m,q.parameter,t,y,A])===false){break UPDATE}if(d(q.callbacks.update.complete,o,[m,q.parameter,t,y,A])===false){break UPDATE}q.fallback?h(o,false):null}if(d(q.callbacks.update.after,o,[m,q.parameter,t,y,A])===false){break UPDATE}}},error:function(F,E,D){A=F;p=E;u=D;d(q.callbacks.ajax.error,o,[m,q.parameter,A,p,u]);q.fallback?h(o,true):null}}))}}function d(o,n,m){if(typeof o==="function"){return o.apply(n,m)}}function g(n){if(!n){return}var m=jQuery.Deferred();setTimeout(function(){m.resolve()},n);return m.promise()}function h(m,n){if(m.href!==undefined){location=m.href}else{if(n){location.reload()}}}return this}})(jQuery);
