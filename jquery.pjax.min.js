/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.7.2
 * @updated 2013/04/12
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;var c=["settings"];function a(q){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var k=window,n=document,l=new Date(),h={id:0,gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false,sync:true,async:0},interval:300,queue:[],wait:0,fallback:true,server:{query:"pjax"},delay:300},g=jQuery.extend(true,{},h,q);jQuery.extend(true,g,{nss:{click:["click",g.gns+(g.ns?":"+g.ns:"")].join("."),submit:["submit",g.gns+(g.ns?":"+g.ns:"")].join("."),popstate:["popstate",g.gns+(g.ns?":"+g.ns:"")].join("."),data:g.gns+(g.ns?":"+g.ns:""),requestHeader:["X",g.gns.replace(/^(\w)/,function(r){return r.toUpperCase()})].join("-")},timestamp:l.getTime()});if(!e()){return this}o(this,g);function e(){if(!p()){return false}if(!jQuery(g.area).length){return false}return true}function p(){return"pushState" in k.history&&k.history.pushState!==null}function o(r,s){s.id=c.length;c.push(s);DELEGATE_CLICK:{if(!s.link){break DELEGATE_CLICK}if(s.form){break DELEGATE_CLICK}jQuery(r).undelegate(s.link,s.nss.click).delegate(s.link,s.nss.click,s.id,function(t){if(t.which>1||t.metaKey||t.ctrlKey||t.shiftKey||t.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}m(this,t,this.href,location.href!==this.href,c[t.data])})}DELEGATE_SUBMIT:{if(!s.form){break DELEGATE_SUBMIT}jQuery(r).undelegate(s.form,s.nss.submit).delegate(s.form,s.nss.submit,s.id,function(t){m(this,t,jQuery(t.target).attr("action"),true,c[t.data])})}BIND_POPSTATE:{jQuery(k).unbind(s.nss.popstate).bind(s.nss.popstate,s.id,function(u){var t=c[u.data];if(t.timestamp!==false&&t.delay>u.timeStamp-t.timestamp){t.timestamp=false;c[t.id]=t;return}m(this,u,location.href,false,c[u.data])})}}function m(t,D,x,r,F){var w=window,J=document,I,B,A,s,G,K,y=[],u=[],H={dataFilter:function(M,L){I=M;B=L;return f(F.callbacks.ajax.dataFilter,t,[D,F.parameter,I,B])},complete:function(M,L){A=M;s=L;f(F.callbacks.ajax.complete,t,[D,F.parameter,A,s])}};for(var E in H){if(E in F.callbacks.ajax){continue}delete H[E]}POPSTATE:{if(D.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{y=x.match(/\?[^\s]*/);if(!y||y[0]==="?"){break GET}F.ajax.type="GET"}F.ajax.data=null}SUBMIT:{if(D.type.toLowerCase()!=="submit"){break SUBMIT}x=x.replace(/\?[^\s]*/,"");F.ajax.type=jQuery(D.target).attr("method").toUpperCase();GET:{if(F.ajax.type!=="GET"){break GET}x+="?"+jQuery(D.target).serialize();F.ajax.data=null}POST:{if(F.ajax.type!=="POST"){break POST}F.ajax.data=jQuery(D.target).serializeArray()}}URL:{if(!F.server.query){break URL}x=x.replace(/(#[^\s]*|)$/,(!x.match(/\?/)?"?":"&")+encodeURIComponent(F.server.query)+"=1$1")}if(f(F.callbacks.before,t,[D,F.parameter])===false){return t}jQuery.when!==undefined?C():v();if(f(F.callbacks.after,t,[D,F.parameter])===false){return t}D.preventDefault();function C(){jQuery.when(i(F.wait),jQuery.ajax(jQuery.extend(true,{},F.ajax,H,{url:x,beforeSend:function(L){A=L;A.setRequestHeader(F.nss.requestHeader,"true");A.setRequestHeader(F.nss.requestHeader+"-Area",F.area);A.setRequestHeader(F.nss.requestHeader+"-CSS",F.load.css);A.setRequestHeader(F.nss.requestHeader+"-Script",F.load.script);f(F.callbacks.ajax.beforeSend,t,[D,F.parameter,A])},success:function(N,M,L){I=N;B=M;A=L;f(F.callbacks.ajax.success,t,[D,F.parameter,I,B,A])},error:function(N,M,L){A=N;s=M;G=L;f(F.callbacks.ajax.error,t,[D,F.parameter,A,s,G]);F.fallback?j(D,t):null}}))).done(function(){z()}).fail().always()}function v(){jQuery.ajax(jQuery.extend(true,{},F.ajax,H,{url:x,beforeSend:function(L){A=L;A.setRequestHeader(F.nss.requestHeader,"true");A.setRequestHeader(F.nss.requestHeader+"-Area",F.area);A.setRequestHeader(F.nss.requestHeader+"-CSS",F.load.css);A.setRequestHeader(F.nss.requestHeader+"-Script",F.load.script);f(F.callbacks.ajax.beforeSend,t,[D,F.parameter,A])},success:function(N,M,L){I=N;B=M;A=L;f(F.callbacks.ajax.success,t,[D,F.parameter,I,B,A]);z()},error:function(N,M,L){A=N;s=M;G=L;f(F.callbacks.ajax.error,t,[D,F.parameter,A,s,G]);F.fallback?j(D,t):null}}))}function z(){UPDATE:{if(f(F.callbacks.update.before,t,[D,F.parameter,I,B,A])===false){break UPDATE}try{if(A.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var U=jQuery(I),R=0<U.filter("title").length,W=R?U.filter("title").text():d(I,"title","<title>([^<]*)</title>"),S,V,L=F.area.split(","),Y=F.scrollLeft===null?jQuery(w).scrollLeft():parseInt(F.scrollLeft),X=F.scrollTop===null?jQuery(w).scrollTop():parseInt(F.scrollTop);if(!jQuery(F.area).length||!U.find(F.area).add(U.filter(F.area)).length){throw new Error()}UPDATE_URL:{if(f(F.callbacks.update.url.before,t,[D,F.parameter,I,B,A])===false){break UPDATE_URL}x=x.replace(new RegExp("[?&]"+F.server.query+"=.*?([sW#&]|$)"),"");r?history.pushState(null,w.opera||("userAgent" in w&&userAgent.indexOf("opera")!==-1)?W:J.title,x):null;if(f(F.callbacks.update.url.after,t,[D,F.parameter,I,B,A])===false){break UPDATE_URL}}UPDATE_TITLE:{if(f(F.callbacks.update.title.before,t,[D,F.parameter,I,B,A])===false){break UPDATE_TITLE}J.title=W;if(f(F.callbacks.update.title.after,t,[D,F.parameter,I,B,A])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(f(F.callbacks.update.content.before,t,[D,F.parameter,I,B,A])===false){break UPDATE_CONTENT}for(var P=0,N;N=L[P];P++){try{jQuery(N).html(U.find(N).add(U.filter(N)).html());F.load.sync?jQuery(N).append(jQuery("<noscript/>",{"data-pjax-loaded":"true",style:"display:none !important;"})):null}catch(O){}}if(f(F.callbacks.update.content.after,t,[D,F.parameter,I,B,A])===false){break UPDATE_CONTENT}}F.load.css?setTimeout(function(){Q()},F.load.async||0):null;function Q(){UPDATE_CSS:{if(f(F.callbacks.update.css.before,t,[D,F.parameter,I,B,A])===false){break UPDATE_CSS}S=R?U.find('link[rel="stylesheet"], style').add(U.filter('link[rel="stylesheet"], style')):d(I,"css",'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)');jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,F.nss.data,true)});for(var aa=0,Z,ab;Z=S[aa];aa++){ab=false;Z=R?Z:jQuery(Z)[0];LINK:{if(Z.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(ab||this.href!==Z.href){return false}ab=true;jQuery.data(this,F.nss.data)?jQuery.data(this,F.nss.data,false):null;return true}).length){continue}}STYLE:{if(Z.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(ab||!jQuery.data(this,F.nss.data)||this.innerHTML!==Z.innerHTML){return false}ab=true;jQuery.data(this,F.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(Z).children(":last-child").get(0),F.nss.data,false);Z=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,F.nss.data)}).remove();if(f(F.callbacks.update.css.after,t,[D,F.parameter,I,B,A])===false){break UPDATE_CSS}}}F.load.script?setTimeout(function(){T("async")},F.load.async||0):null;function T(ab){UPDATE_SCRIPT:{if(f(F.callbacks.update.script.before,t,[D,F.parameter,I,B,A])===false){break UPDATE_SCRIPT}V=R?U.find("script").add(U.filter("script")):d(I,"script","([^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?<\/script>)([^'\"]|s*$)");for(var aa=0,Z,ad,ac;Z=V[aa];aa++){ac=false;Z=R?Z:jQuery(Z)[0];if(F.load.sync&&ab==="sync"&&!Z.defer){continue}if(F.load.sync&&ab==="async"&&Z.defer){continue}if(jQuery("script[src]").filter(function(){if(ac||this.src!==Z.src){return false}ac=true;return true}).length){continue}jQuery.data(jQuery("head").append(Z).children(":last-child").get(0),F.nss.data,false);Z=null}if(f(F.callbacks.update.script.after,t,[D,F.parameter,I,B,A])===false){break UPDATE_SCRIPT}}}if(F.load.script&&F.load.sync){var M=setTimeout(function(){while(M=F.queue.shift()){clearTimeout(M)}if(jQuery(F.area).length===jQuery(F.area).children("noscript[data-pjax-loaded]").length){jQuery(F.area).children("noscript[data-pjax-loaded]").remove();setTimeout(function(){T("sync")},0)}else{M=setTimeout(arguments.callee,F.interval);F.queue.push(M)}c[F.id]=F},F.interval);F.queue.push(M);c[F.id]=F}r&&-1<"click,submit".indexOf(D.type.toLowerCase())?w.scrollTo(Y,X):null;if(f(F.callbacks.update.success,t,[D,F.parameter,I,B,A])===false){break UPDATE}if(f(F.callbacks.update.complete,t,[D,F.parameter,I,B,A])===false){break UPDATE}if(f(F.callback,t,[D,F.parameter,I,B,A])===false){break UPDATE}}catch(O){if(f(F.callbacks.update.error,t,[D,F.parameter,I,B,A])===false){break UPDATE}if(f(F.callbacks.update.complete,t,[D,F.parameter,I,B,A])===false){break UPDATE}F.fallback?j(D,t):null}if(f(F.callbacks.update.after,t,[D,F.parameter,I,B,A])===false){break UPDATE}}}}function f(t,s,r){if(typeof t==="function"){return t.apply(s,r)}}function i(s){var r=jQuery.Deferred();if(!s){return r.resolve()}setTimeout(function(){r.resolve()},s);return r.promise()}function j(t,r,s){if(t.type.toLowerCase()==="click"){location.href=r.href}else{if(t.type.toLowerCase()==="submit"){r.submit()}else{if(t.type.toLowerCase()==="popstate"){location.reload()}}}}function d(v,s,u){var t,r=[];t=new RegExp(u,"gim");switch(s){case"title":v.replace(t,function(x,w){r.push(w)});break;case"css":v.replace(t,function(w){r.push(w)});break;case"script":v.replace(t,function(x,w,y){r.push(y)});break}return r}return this}})(jQuery);
