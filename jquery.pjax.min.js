/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.6.3
 * @updated 2013/04/05
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @CodingConventions Google JavaScript Style Guide
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;function a(m){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var g={gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false,async:{css:false,script:false}},wait:0,fallback:true,server:{query:"pjax"}},f=jQuery.extend(true,{},g,m);jQuery.extend(true,f,{nss:{click:["click",f.gns+(f.ns?":"+f.ns:"")].join("."),submit:["submit",f.gns+(f.ns?":"+f.ns:"")].join("."),popstate:["popstate",f.gns+(f.ns?":"+f.ns:"")].join("."),data:f.gns+(f.ns?":"+f.ns:""),requestHeader:["X",f.gns.replace(/^(\w)/,function(n){return n.toUpperCase()})].join("-")}});if(!d()){return this}k(this,f);function d(){if(!l()){return false}if(!jQuery(f.area).length){return false}return true}function l(){return"pushState" in window.history&&window.history.pushState!==null}function k(n,o){DELEGATE_CLICK:{if(!o.link){break DELEGATE_CLICK}if(o.form){break DELEGATE_CLICK}jQuery(n).undelegate(o.link,o.nss.click).delegate(o.link,o.nss.click,o,function(p){if(p.which>1||p.metaKey||p.ctrlKey||p.shiftKey||p.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}j(this,p,this.href,location.href!==this.href,p.data)})}DELEGATE_SUBMIT:{if(!o.form){break DELEGATE_SUBMIT}jQuery(n).undelegate(o.form,o.nss.submit).delegate(o.form,o.nss.submit,o,function(p){j(this,p,jQuery(p.target).attr("action"),true,p.data)})}BIND_POPSTATE:{setTimeout(function(){jQuery(window).unbind(o.nss.popstate).bind(o.nss.popstate,o,function(p){j(this,p,location.href,false,p.data)})},100)}}function j(p,y,t,n,A){var s=window,E=document,D,w,v,o,B,F,u=[],q=[],C={dataFilter:function(H,G){D=H;w=G;return e(A.callbacks.ajax.dataFilter,p,[y,A.parameter,D,w])},complete:function(H,G){v=H;o=G;e(A.callbacks.ajax.complete,p,[y,A.parameter,v,o])}};for(var z in C){if(z in A.callbacks.ajax){continue}delete C[z]}POPSTATE:{if(y.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{u=t.match(/\?[^\s]*/);if(!u||u[0]==="?"){break GET}A.ajax.type="GET"}A.ajax.data=null}SUBMIT:{if(y.type.toLowerCase()!=="submit"){break SUBMIT}t=t.replace(/\?[^\s]*/,"");A.ajax.type=jQuery(y.target).attr("method").toUpperCase();GET:{if(A.ajax.type!=="GET"){break GET}t+="?"+jQuery(y.target).serialize();A.ajax.data=null}POST:{if(A.ajax.type!=="POST"){break POST}A.ajax.data=jQuery(y.target).serializeArray()}}URL:{if(!A.server.query){break URL}t=t.replace(/(#[^\s]*|)$/,(!t.match(/\?/)?"?":"&")+encodeURIComponent(A.server.query)+"=1$1")}if(e(A.callbacks.before,p,[y,A.parameter])===false){return p}switch(jQuery().jquery){case"1.0":case"1.0.4":case"1.1.0":case"1.1.2":case"1.1.3":case"1.1.4":case"1.2":case"1.2.3":case"1.2.6":case"1.3":case"1.4":case"1.4.1":case"1.4.2":case"1.4.3":case"1.4.4":r();break;case"1.5":case"1.5.1":case"1.5.2":case"1.6":case"1.6.1":case"1.6.2":case"1.6.3":case"1.6.4":case"1.7":case"1.7.1":case"1.7.2":case"1.8":case"1.8.1":case"1.8.2":case"1.8.3":case"1.9":case"1.9.1":default:x();break}if(e(A.callbacks.after,p,[y,A.parameter])===false){return p}y.preventDefault();function x(){jQuery.when(h(A.wait),jQuery.ajax(jQuery.extend(true,{},A.ajax,C,{url:t,beforeSend:function(G){v=G;v.setRequestHeader(A.nss.requestHeader,"true");v.setRequestHeader(A.nss.requestHeader+"-Area",A.area);v.setRequestHeader(A.nss.requestHeader+"-CSS",A.load.css);v.setRequestHeader(A.nss.requestHeader+"-Script",A.load.script);e(A.callbacks.ajax.beforeSend,p,[y,A.parameter,v])},success:function(I,H,G){D=I;w=H;v=G;e(A.callbacks.ajax.success,p,[y,A.parameter,D,w,v])},error:function(I,H,G){v=I;o=H;B=G;e(A.callbacks.ajax.error,p,[y,A.parameter,v,o,B]);A.fallback?i(p):null}}))).done(function(O){UPDATE:{var I=O.fire;if(I(A.callbacks.update.before,p,[y,A.parameter,D,w,v])===false){break UPDATE}try{if(v.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var Q=jQuery(D).filter("title").text(),M=c(D,'<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>'),P=c(D,"([^'\"]|^)<script[^>]*?>(.|[\n\r])*?<\/script>([^'\"]|$)"),G=A.area.split(","),S=A.scrollLeft===null?jQuery(s).scrollLeft():parseInt(A.scrollLeft),R=A.scrollTop===null?jQuery(s).scrollTop():parseInt(A.scrollTop);if(!jQuery(A.area).length||!jQuery(A.area,D).add(jQuery(D).filter(A.area)).length){throw new Error()}UPDATE_URL:{if(I(A.callbacks.update.url.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_URL}t=t.replace(new RegExp("[?&]"+A.server.query+"=.*?([sW#&]|$)"),"");n?history.pushState(null,s.opera||("userAgent" in s&&userAgent.indexOf("opera")!==-1)?Q:E.title,t):null;if(I(A.callbacks.update.url.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_URL}}UPDATE_TITLE:{if(I(A.callbacks.update.title.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_TITLE}E.title=Q;if(I(A.callbacks.update.title.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(I(A.callbacks.update.content.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_CONTENT}for(var K=0,H;H=G[K];K++){try{jQuery(H).html(jQuery(H,D).add(jQuery(D).filter(H)).html())}catch(J){}}if(I(A.callbacks.update.content.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_CONTENT}}function L(){var V=O.filter;UPDATE_CSS:{if(!A.load.css){break UPDATE_CSS}if(I(A.callbacks.update.css.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,A.nss.data,true)});for(var U=0,T,W;T=M[U];U++){T=jQuery(T)[0];W=false;LINK:{if(T.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(W||this.href!==T.href){return false}W=true;jQuery.data(this,A.nss.data)?jQuery.data(this,A.nss.data,false):null;return true}).length){continue}}STYLE:{if(T.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(W||!jQuery.data(this,A.nss.data)||this.innerHTML!==T.innerHTML){return false}W=true;jQuery.data(this,A.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(T).children(":last-child").get(0),A.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,A.nss.data)}).remove();if(I(A.callbacks.update.css.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_CSS}}}A.load.async.css===false?L():setTimeout(function(){L()},A.load.async.css);function N(){var V=O.filter;UPDATE_SCRIPT:{if(!A.load.script){break UPDATE_SCRIPT}if(I(A.callbacks.update.script.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_SCRIPT}for(var U=0,T,W;T=P[U];U++){T=jQuery(T)[0];W=false;if(jQuery("script[src]").filter(function(){if(W||this.src!==T.src){return false}W=true;return true}).length){continue}jQuery.data(jQuery("head").append(T).children(":last-child").get(0),A.nss.data,false)}if(I(A.callbacks.update.script.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_SCRIPT}}}A.load.async.script===false?N():setTimeout(function(){N()},A.load.async.script);n&&-1<"click,submit".indexOf(y.type.toLowerCase())?s.scrollTo(S,R):null;if(I(A.callbacks.update.success,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callbacks.update.complete,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callback,p,[y,A.parameter,D,w,v])===false){break UPDATE}}catch(J){if(I(A.callbacks.update.error,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callbacks.update.complete,p,[y,A.parameter,D,w,v])===false){break UPDATE}A.fallback?i(p):null}if(I(A.callbacks.update.after,p,[y,A.parameter,D,w,v])===false){break UPDATE}}}).fail().always()}function r(){jQuery.ajax(jQuery.extend(true,{},A.ajax,C,{url:t,beforeSend:function(G){v=G;v.setRequestHeader(A.nss.requestHeader,"true");v.setRequestHeader(A.nss.requestHeader+"-Area",A.area);v.setRequestHeader(A.nss.requestHeader+"-CSS",A.load.css);v.setRequestHeader(A.nss.requestHeader+"-Script",A.load.script);e(A.callbacks.ajax.beforeSend,p,[y,A.parameter,v])},success:function(P,M,L){D=P;w=M;v=L;I(A.callbacks.ajax.success,p,[y,A.parameter,D,w,v]);UPDATE:{var I=fn.fire;if(I(A.callbacks.update.before,p,[y,A.parameter,D,w,v])===false){break UPDATE}try{if(v.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var S=jQuery(D).filter("title").text(),O=c(D,'<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>'),R=c(D,"([^'\"]|^)<script[^>]*?>(.|[\n\r])*?<\/script>([^'\"]|$)"),G=A.area.split(","),U=A.scrollLeft===null?jQuery(s).scrollLeft():parseInt(A.scrollLeft),T=A.scrollTop===null?jQuery(s).scrollTop():parseInt(A.scrollTop);if(!jQuery(A.area).length||!jQuery(A.area,D).add(jQuery(D).filter(A.area)).length){throw new Error()}UPDATE_URL:{if(I(A.callbacks.update.url.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_URL}t=t.replace(new RegExp("[?&]"+A.server.query+"=.*?([sW#&]|$)"),"");n?history.pushState(null,s.opera||("userAgent" in s&&userAgent.indexOf("opera")!==-1)?S:E.title,t):null;if(I(A.callbacks.update.url.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_URL}}UPDATE_TITLE:{if(I(A.callbacks.update.title.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_TITLE}E.title=S;if(I(A.callbacks.update.title.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(I(A.callbacks.update.content.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_CONTENT}for(var K=0,H;H=G[K];K++){try{jQuery(H).html(jQuery(H,D).add(jQuery(D).filter(H)).html())}catch(J){}}if(I(A.callbacks.update.content.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_CONTENT}}function N(){var X=fn.filter;UPDATE_CSS:{if(!A.load.css){break UPDATE_CSS}if(I(A.callbacks.update.css.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,A.nss.data,true)});for(var W=0,V,Y;V=O[W];W++){V=jQuery(V)[0];Y=false;LINK:{if(V.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(Y||this.href!==V.href){return false}Y=true;jQuery.data(this,A.nss.data)?jQuery.data(this,A.nss.data,false):null;return true}).length){continue}}STYLE:{if(V.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(Y||!jQuery.data(this,A.nss.data)||this.innerHTML!==V.innerHTML){return false}Y=true;jQuery.data(this,A.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(V).children(":last-child").get(0),A.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,A.nss.data)}).remove();if(I(A.callbacks.update.css.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_CSS}}}A.load.async.css===false?N():setTimeout(function(){N()},A.load.async.css);function Q(){var X=fn.filter;UPDATE_SCRIPT:{if(!A.load.script){break UPDATE_SCRIPT}if(I(A.callbacks.update.script.before,p,[y,A.parameter,D,w,v])===false){break UPDATE_SCRIPT}for(var W=0,V,Y;V=R[W];W++){V=jQuery(V)[0];Y=false;if(jQuery("script[src]").filter(function(){if(Y||this.src!==V.src){return false}Y=true;return true}).length){continue}jQuery.data(jQuery("head").append(V).children(":last-child").get(0),A.nss.data,false)}if(I(A.callbacks.update.script.after,p,[y,A.parameter,D,w,v])===false){break UPDATE_SCRIPT}}}A.load.async.script===false?Q():setTimeout(function(){Q()},A.load.async.script);n&&-1<"click,submit".indexOf(y.type.toLowerCase())?s.scrollTo(U,T):null;if(I(A.callbacks.update.success,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callbacks.update.complete,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callback,p,[y,A.parameter,D,w,v])===false){break UPDATE}}catch(J){if(I(A.callbacks.update.error,p,[y,A.parameter,D,w,v])===false){break UPDATE}if(I(A.callbacks.update.complete,p,[y,A.parameter,D,w,v])===false){break UPDATE}A.fallback?i(p):null}if(I(A.callbacks.update.after,p,[y,A.parameter,D,w,v])===false){break UPDATE}}},error:function(I,H,G){v=I;o=H;B=G;e(A.callbacks.ajax.error,p,[y,A.parameter,v,o,B]);A.fallback?i(p,true):null}}))}}function e(p,o,n){if(typeof p==="function"){return p.apply(o,n)}}function h(o){var n=jQuery.Deferred();if(!o){return n.resolve({fire:e,filter:c})}setTimeout(function(){n.resolve({fire:e,filter:c})},o);return n.promise()}function i(n){if(n.tagName.toUpperCase()==="A"){location=n.href}else{if(n.tagName.toUpperCase()==="FORM"){n.submit()}else{location.reload()}}}function c(q,p){var o,n;o=new RegExp(p,"gim");n=q.match(o);return n}return this}})(jQuery);
