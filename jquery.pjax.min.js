/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.6.2
 * @updated 2013/04/04
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @CodingConventions Google JavaScript Style Guide
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;function a(m){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var g={gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false,async:{css:false,script:false}},wait:0,fallback:true,server:{query:"pjax"}},f=jQuery.extend(true,{},g,m);jQuery.extend(true,f,{nss:{click:["click",f.gns+(f.ns?":"+f.ns:"")].join("."),submit:["submit",f.gns+(f.ns?":"+f.ns:"")].join("."),popstate:["popstate",f.gns+(f.ns?":"+f.ns:"")].join("."),data:f.gns+(f.ns?":"+f.ns:""),requestHeader:["X",f.gns.replace(/^(\w)/,function(n){return n.toUpperCase()})].join("-")}});if(!d()){return this}k(this,f);function d(){if(!l()){return false}if(!jQuery(f.area).length){return false}return true}function l(){return"pushState" in window.history&&window.history.pushState!==null}function k(n,o){DELEGATE_CLICK:{if(!o.link){break DELEGATE_CLICK}if(o.form){break DELEGATE_CLICK}jQuery(n).undelegate(o.link,o.nss.click).delegate(o.link,o.nss.click,o,function(p){if(p.which>1||p.metaKey||p.ctrlKey||p.shiftKey||p.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}j(this,p,this.href,location.href!==this.href,p.data)})}DELEGATE_SUBMIT:{if(!o.form){break DELEGATE_SUBMIT}jQuery(n).undelegate(o.form,o.nss.submit).delegate(o.form,o.nss.submit,o,function(p){j(this,p,jQuery(p.target).attr("action"),true,p.data)})}BIND_POPSTATE:{setTimeout(function(){jQuery(window).unbind(o.nss.popstate).bind(o.nss.popstate,o,function(p){j(this,p,location.href,false,p.data)})},100)}}function j(p,n,o,C,r){var u,z,B,q,v,y,x=[],s=[],w={dataFilter:function(F,E){u=F;z=E;return e(r.callbacks.ajax.dataFilter,p,[n,r.parameter,u,z])},complete:function(F,E){B=F;q=E;e(r.callbacks.ajax.complete,p,[n,r.parameter,B,q])}};for(var t in w){if(t in r.callbacks.ajax){continue}delete w[t]}POPSTATE:{if(n.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{x=o.match(/\?[^\s]*/);if(!x||x[0]==="?"){break GET}r.ajax.type="GET"}delete r.ajax.data}SUBMIT:{if(n.type.toLowerCase()!=="submit"){break SUBMIT}o=o.replace(/\?[^\s]*/,"");r.ajax.type=jQuery(n.target).attr("method").toUpperCase();GET:{if(r.ajax.type!=="GET"){break GET}o+="?"+jQuery(n.target).serialize();delete r.ajax.data}POST:{if(r.ajax.type!=="POST"){break POST}r.ajax.data=jQuery(n.target).serializeArray()}}URL:{if(!r.server.query){break URL}o=o.replace(/(#[^\s]*|)$/,(!o.match(/\?/)?"?":"&")+encodeURIComponent(r.server.query)+"=1$1")}if(e(r.callbacks.before,p,[n,r.parameter])===false){return p}switch(jQuery().jquery){case"1.0":case"1.0.4":case"1.1.0":case"1.1.2":case"1.1.3":case"1.1.4":case"1.2":case"1.2.3":case"1.2.6":case"1.3":case"1.4":case"1.4.1":case"1.4.2":case"1.4.3":case"1.4.4":D();break;case"1.5":case"1.5.1":case"1.5.2":case"1.6":case"1.6.1":case"1.6.2":case"1.6.3":case"1.6.4":case"1.7":case"1.7.1":case"1.7.2":case"1.8":case"1.8.1":case"1.8.2":case"1.8.3":case"1.9":case"1.9.1":default:A();break}if(e(r.callbacks.after,p,[n,r.parameter])===false){return p}n.preventDefault();function A(){jQuery.when(h(r.wait),jQuery.ajax(jQuery.extend(true,{},r.ajax,w,{url:o,beforeSend:function(E){B=E;B.setRequestHeader(r.nss.requestHeader,"true");B.setRequestHeader(r.nss.requestHeader+"-Area",r.area);B.setRequestHeader(r.nss.requestHeader+"-CSS",r.load.css);B.setRequestHeader(r.nss.requestHeader+"-Script",r.load.script);e(r.callbacks.ajax.beforeSend,p,[n,r.parameter,B])},success:function(G,F,E){u=G;z=F;B=E;e(r.callbacks.ajax.success,p,[n,r.parameter,u,z,B])},error:function(G,F,E){B=G;q=F;v=E;e(r.callbacks.ajax.error,p,[n,r.parameter,B,q,v]);r.fallback?i(p):null}}))).done(function(){UPDATE:{if(e(r.callbacks.update.before,p,[n,r.parameter,u,z,B])===false){break UPDATE}try{if(B.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var M=jQuery(u).filter("title").text(),J=c(u,'<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>'),L=c(u,"<script[^>]*?>(.|[\n\r])*?<\/script>"),E=r.area.split(","),O=r.scrollLeft===null?jQuery(window).scrollLeft():parseInt(r.scrollLeft),N=r.scrollTop===null?jQuery(window).scrollTop():parseInt(r.scrollTop);if(!jQuery(r.area).length||!jQuery(r.area,u).add(jQuery(u).filter(r.area)).length){throw new Error()}UPDATE_URL:{if(e(r.callbacks.update.url.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_URL}o=o.replace(new RegExp("[?&]"+r.server.query+"=.*?([sW#&]|$)"),"");C?history.pushState(null,window.opera||("userAgent" in window&&userAgent.indexOf("opera")!==-1)?M:document.title,o):null;if(e(r.callbacks.update.url.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_URL}}UPDATE_TITLE:{if(e(r.callbacks.update.title.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_TITLE}document.title=M;if(e(r.callbacks.update.title.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(e(r.callbacks.update.content.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_CONTENT}for(var H=0,F;F=E[H];H++){try{jQuery(F).html(jQuery(F,u).add(jQuery(u).filter(F)).html())}catch(G){}}if(e(r.callbacks.update.content.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_CONTENT}}function I(){UPDATE_CSS:{if(!r.load.css){break UPDATE_CSS}if(e(r.callbacks.update.css.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,r.nss.data,true)});for(var Q=0,P;P=J[Q];Q++){P=jQuery(P)[0];LINK:{if(P.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(this.href===P.href){jQuery.data(this,r.nss.data)?jQuery.data(this,r.nss.data,false):null;return true}return false}).length){continue}}STYLE:{if(P.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(this.innerHTML===P.innerHTML){jQuery.data(this,r.nss.data)?jQuery.data(this,r.nss.data,false):null;return true}return false}).length){continue}}jQuery.data(jQuery("head").append(P).children(":last-child").get(0),r.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,r.nss.data)}).remove();if(e(r.callbacks.update.css.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_CSS}}}r.load.async.css===false?I():setTimeout(function(){I()},r.load.async.css);function K(){UPDATE_SCRIPT:{if(!r.load.script){break UPDATE_SCRIPT}if(e(r.callbacks.update.script.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_SCRIPT}for(var Q=0,P;P=L[Q];Q++){P=jQuery(P)[0];if(jQuery("script[src]").filter(function(){if(this.src===P.src){return true}return false}).length){continue}jQuery.data(jQuery("head").append(P).children(":last-child").get(0),r.nss.data,false)}if(e(r.callbacks.update.script.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_SCRIPT}}}r.load.async.script===false?K():setTimeout(function(){K()},r.load.async.script);C&&n.type.toLowerCase()==="click"?window.scrollTo(O,N):null;if(e(r.callbacks.update.success,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callbacks.update.complete,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callback,p,[n,r.parameter,u,z,B])===false){break UPDATE}}catch(G){if(e(r.callbacks.update.error,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callbacks.update.complete,p,[n,r.parameter,u,z,B])===false){break UPDATE}r.fallback?i(p):null}if(e(r.callbacks.update.after,p,[n,r.parameter,u,z,B])===false){break UPDATE}}}).fail().always()}function D(){jQuery.ajax(jQuery.extend(true,{},r.ajax,w,{url:o,beforeSend:function(E){B=E;B.setRequestHeader(r.nss.requestHeader,"true");B.setRequestHeader(r.nss.requestHeader+"-Area",r.area);B.setRequestHeader(r.nss.requestHeader+"-CSS",r.load.css);B.setRequestHeader(r.nss.requestHeader+"-Script",r.load.script);e(r.callbacks.ajax.beforeSend,p,[n,r.parameter,B])},success:function(M,J,I){u=M;z=J;B=I;e(r.callbacks.ajax.success,p,[n,r.parameter,u,z,B]);UPDATE:{if(e(r.callbacks.update.before,p,[n,r.parameter,u,z,B])===false){break UPDATE}try{if(B.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var P=jQuery(u).filter("title").text(),L=c(u,'<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>'),O=c(u,"<script[^>]*?>(.|[\n\r])*?<\/script>"),E=r.area.split(","),R=r.scrollLeft===null?jQuery(window).scrollLeft():parseInt(r.scrollLeft),Q=r.scrollTop===null?jQuery(window).scrollTop():parseInt(r.scrollTop);if(!jQuery(r.area).length||!jQuery(r.area,u).add(jQuery(u).filter(r.area)).length){throw new Error()}UPDATE_URL:{if(e(r.callbacks.update.url.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_URL}o=o.replace(new RegExp("[?&]"+r.server.query+"=.*?([sW#&]|$)"),"");C?history.pushState(null,window.opera||("userAgent" in window&&userAgent.indexOf("opera")!==-1)?P:document.title,o):null;if(e(r.callbacks.update.url.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_URL}}UPDATE_TITLE:{if(e(r.callbacks.update.title.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_TITLE}document.title=P;if(e(r.callbacks.update.title.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(e(r.callbacks.update.content.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_CONTENT}for(var H=0,F;F=E[H];H++){try{jQuery(F).html(jQuery(F,u).add(jQuery(u).filter(F)).html())}catch(G){}}if(e(r.callbacks.update.content.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_CONTENT}}function K(){UPDATE_CSS:{if(!r.load.css){break UPDATE_CSS}if(e(r.callbacks.update.css.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,r.nss.data,true)});for(var T=0,S;S=L[T];T++){S=jQuery(S)[0];LINK:{if(S.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(this.href===S.href){jQuery.data(this,r.nss.data)?jQuery.data(this,r.nss.data,false):null;return true}return false}).length){continue}}STYLE:{if(S.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(this.innerHTML===S.innerHTML){jQuery.data(this,r.nss.data)?jQuery.data(this,r.nss.data,false):null;return true}return false}).length){continue}}jQuery.data(jQuery("head").append(S).children(":last-child").get(0),r.nss.data,false)}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,r.nss.data)}).remove();if(e(r.callbacks.update.css.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_CSS}}}r.load.async.css===false?K():setTimeout(function(){K()},r.load.async.css);function N(){UPDATE_SCRIPT:{if(!r.load.script){break UPDATE_SCRIPT}if(e(r.callbacks.update.script.before,p,[n,r.parameter,u,z,B])===false){break UPDATE_SCRIPT}for(var T=0,S;S=O[T];T++){S=jQuery(S)[0];if(jQuery("script[src]").filter(function(){if(this.src===S.src){return true}return false}).length){continue}jQuery.data(jQuery("head").append(S).children(":last-child").get(0),r.nss.data,false)}if(e(r.callbacks.update.script.after,p,[n,r.parameter,u,z,B])===false){break UPDATE_SCRIPT}}}r.load.async.script===false?N():setTimeout(function(){N()},r.load.async.script);C&&n.type.toLowerCase()==="click"?window.scrollTo(R,Q):null;if(e(r.callbacks.update.success,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callbacks.update.complete,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callback,p,[n,r.parameter,u,z,B])===false){break UPDATE}}catch(G){if(e(r.callbacks.update.error,p,[n,r.parameter,u,z,B])===false){break UPDATE}if(e(r.callbacks.update.complete,p,[n,r.parameter,u,z,B])===false){break UPDATE}r.fallback?i(p):null}if(e(r.callbacks.update.after,p,[n,r.parameter,u,z,B])===false){break UPDATE}}},error:function(G,F,E){B=G;q=F;v=E;e(r.callbacks.ajax.error,p,[n,r.parameter,B,q,v]);r.fallback?i(p,true):null}}))}}function e(p,o,n){if(typeof p==="function"){return p.apply(o,n)}}function h(o){if(!o){return}var n=jQuery.Deferred();setTimeout(function(){n.resolve()},o);return n.promise()}function i(n){if(n.tagName.toUpperCase()==="A"){location=n.href}else{if(n.tagName.toUpperCase()==="FORM"){n.submit()}else{location.reload()}}}function c(q,p){var o,n;o=new RegExp(p,"gim");n=q.match(o);return n}return this}})(jQuery);
