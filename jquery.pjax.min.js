/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.7.0
 * @updated 2013/04/10
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @CodingConventions Google JavaScript Style Guide
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;var c=["settings"];function a(q){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var k=window,n=document,l=new Date(),h={id:0,gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false,sync:true},interval:300,queue:[],wait:0,fallback:true,server:{query:"pjax"},timestamp:0},g=jQuery.extend(true,{},h,q);jQuery.extend(true,g,{nss:{click:["click",g.gns+(g.ns?":"+g.ns:"")].join("."),submit:["submit",g.gns+(g.ns?":"+g.ns:"")].join("."),popstate:["popstate",g.gns+(g.ns?":"+g.ns:"")].join("."),data:g.gns+(g.ns?":"+g.ns:""),requestHeader:["X",g.gns.replace(/^(\w)/,function(r){return r.toUpperCase()})].join("-")},load:{async:{css:false,script:false}},timestamp:l.getTime()});if(!e()){return this}o(this,g);function e(){if(!p()){return false}if(!jQuery(g.area).length){return false}return true}function p(){return"pushState" in k.history&&k.history.pushState!==null}function o(r,s){s.id=c.length;c.push(s);DELEGATE_CLICK:{if(!s.link){break DELEGATE_CLICK}if(s.form){break DELEGATE_CLICK}jQuery(r).undelegate(s.link,s.nss.click).delegate(s.link,s.nss.click,s.id,function(t){if(t.which>1||t.metaKey||t.ctrlKey||t.shiftKey||t.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}m(this,t,this.href,location.href!==this.href,c[t.data])})}DELEGATE_SUBMIT:{if(!s.form){break DELEGATE_SUBMIT}jQuery(r).undelegate(s.form,s.nss.submit).delegate(s.form,s.nss.submit,s.id,function(t){m(this,t,jQuery(t.target).attr("action"),true,c[t.data])})}BIND_POPSTATE:{jQuery(k).unbind(s.nss.popstate).bind(s.nss.popstate,s.id,function(t){if(300>t.timeStamp-c[t.data].timestamp){return}m(this,t,location.href,false,c[t.data])})}}function m(t,C,x,r,E){var w=window,I=document,H,A,z,s,F,J,y=[],u=[],G={dataFilter:function(L,K){H=L;A=K;return f(E.callbacks.ajax.dataFilter,t,[C,E.parameter,H,A])},complete:function(L,K){z=L;s=K;f(E.callbacks.ajax.complete,t,[C,E.parameter,z,s])}};for(var D in G){if(D in E.callbacks.ajax){continue}delete G[D]}POPSTATE:{if(C.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{y=x.match(/\?[^\s]*/);if(!y||y[0]==="?"){break GET}E.ajax.type="GET"}E.ajax.data=null}SUBMIT:{if(C.type.toLowerCase()!=="submit"){break SUBMIT}x=x.replace(/\?[^\s]*/,"");E.ajax.type=jQuery(C.target).attr("method").toUpperCase();GET:{if(E.ajax.type!=="GET"){break GET}x+="?"+jQuery(C.target).serialize();E.ajax.data=null}POST:{if(E.ajax.type!=="POST"){break POST}E.ajax.data=jQuery(C.target).serializeArray()}}URL:{if(!E.server.query){break URL}x=x.replace(/(#[^\s]*|)$/,(!x.match(/\?/)?"?":"&")+encodeURIComponent(E.server.query)+"=1$1")}if(f(E.callbacks.before,t,[C,E.parameter])===false){return t}switch(jQuery().jquery){case"1.0":case"1.0.4":case"1.1.0":case"1.1.2":case"1.1.3":case"1.1.4":case"1.2":case"1.2.3":case"1.2.6":case"1.3":case"1.4":case"1.4.1":case"1.4.2":case"1.4.3":case"1.4.4":v();break;case"1.5":case"1.5.1":case"1.5.2":case"1.6":case"1.6.1":case"1.6.2":case"1.6.3":case"1.6.4":case"1.7":case"1.7.1":case"1.7.2":case"1.8":case"1.8.1":case"1.8.2":case"1.8.3":case"1.9":case"1.9.1":default:B();break}if(f(E.callbacks.after,t,[C,E.parameter])===false){return t}C.preventDefault();function B(){jQuery.when(i(E.wait),jQuery.ajax(jQuery.extend(true,{},E.ajax,G,{url:x,beforeSend:function(K){z=K;z.setRequestHeader(E.nss.requestHeader,"true");z.setRequestHeader(E.nss.requestHeader+"-Area",E.area);z.setRequestHeader(E.nss.requestHeader+"-CSS",E.load.css);z.setRequestHeader(E.nss.requestHeader+"-Script",E.load.script);f(E.callbacks.ajax.beforeSend,t,[C,E.parameter,z])},success:function(M,L,K){H=M;A=L;z=K;f(E.callbacks.ajax.success,t,[C,E.parameter,H,A,z])},error:function(M,L,K){z=M;s=L;F=K;f(E.callbacks.ajax.error,t,[C,E.parameter,z,s,F]);E.fallback?j(C,t):null}}))).done(function(T){UPDATE:{var N=T.fire;if(N(E.callbacks.update.before,t,[C,E.parameter,H,A,z])===false){break UPDATE}try{if(z.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var V=jQuery(H).filter("title").text(),R=d(H,"css",'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)'),U=d(H,"script","([^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?<\/script>)([^'\"]|s*$)"),K=E.area.split(","),X=E.scrollLeft===null?jQuery(w).scrollLeft():parseInt(E.scrollLeft),W=E.scrollTop===null?jQuery(w).scrollTop():parseInt(E.scrollTop);if(!jQuery(E.area).length||!jQuery(E.area,H).add(jQuery(H).filter(E.area)).length){throw new Error()}UPDATE_URL:{if(N(E.callbacks.update.url.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_URL}x=x.replace(new RegExp("[?&]"+E.server.query+"=.*?([sW#&]|$)"),"");r?history.pushState(null,w.opera||("userAgent" in w&&userAgent.indexOf("opera")!==-1)?V:I.title,x):null;if(N(E.callbacks.update.url.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_URL}}UPDATE_TITLE:{if(N(E.callbacks.update.title.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_TITLE}I.title=V;if(N(E.callbacks.update.title.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(N(E.callbacks.update.content.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_CONTENT}for(var P=0,M;M=K[P];P++){try{jQuery(M).html(jQuery(M,H).add(jQuery(H).filter(M)).html());E.load.sync?jQuery(M).append(jQuery("<div/>",{"data-pjax-loaded":"true",style:"display:none;"})):null}catch(O){}}if(N(E.callbacks.update.content.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_CONTENT}}function Q(){var aa=T.filter;UPDATE_CSS:{if(!E.load.css){break UPDATE_CSS}if(N(E.callbacks.update.css.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,E.nss.data,true)});for(var Z=0,Y,ab;Y=R[Z];Z++){Y=jQuery(Y)[0];ab=false;LINK:{if(Y.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(ab||this.href!==Y.href){return false}ab=true;jQuery.data(this,E.nss.data)?jQuery.data(this,E.nss.data,false):null;return true}).length){continue}}STYLE:{if(Y.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(ab||!jQuery.data(this,E.nss.data)||this.innerHTML!==Y.innerHTML){return false}ab=true;jQuery.data(this,E.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(Y).children(":last-child").get(0),E.nss.data,false);Y=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,E.nss.data)}).remove();if(N(E.callbacks.update.css.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_CSS}}}E.load.sync?null:E.load.async.css===false?Q():setTimeout(function(){Q()},E.load.async.css);function S(){var aa=T.filter;UPDATE_SCRIPT:{if(!E.load.script){break UPDATE_SCRIPT}if(N(E.callbacks.update.script.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_SCRIPT}for(var Z=0,Y,ab;Y=U[Z];Z++){Y=jQuery(Y)[0];ab=false;if(jQuery("script[src]").filter(function(){if(ab||this.src!==Y.src){return false}ab=true;return true}).length){continue}jQuery.data(jQuery("head").append(Y).children(":last-child").get(0),E.nss.data,false);Y=null}if(N(E.callbacks.update.script.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_SCRIPT}}}E.load.sync?null:E.load.async.script===false?S():setTimeout(function(){S()},E.load.async.script);if(E.load.sync){var L=setTimeout(function(){while(L=E.queue.shift()){clearTimeout(L)}if(jQuery(E.area).length===jQuery(E.area).children("div[data-pjax-loaded]").length){jQuery(E.area).children("div[data-pjax-loaded]").remove();Q();S()}else{L=setTimeout(arguments.callee,E.interval);E.queue.push(L)}c[E.id]=E},E.interval);E.queue.push(L);c[E.id]=E}r&&-1<"click,submit".indexOf(C.type.toLowerCase())?w.scrollTo(X,W):null;if(N(E.callbacks.update.success,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callbacks.update.complete,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callback,t,[C,E.parameter,H,A,z])===false){break UPDATE}}catch(O){if(N(E.callbacks.update.error,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callbacks.update.complete,t,[C,E.parameter,H,A,z])===false){break UPDATE}E.fallback?j(C,t):null}if(N(E.callbacks.update.after,t,[C,E.parameter,H,A,z])===false){break UPDATE}H=null;A=null;z=null;s=null;F=null}}).fail().always()}function v(){jQuery.ajax(jQuery.extend(true,{},E.ajax,G,{url:x,beforeSend:function(K){z=K;z.setRequestHeader(E.nss.requestHeader,"true");z.setRequestHeader(E.nss.requestHeader+"-Area",E.area);z.setRequestHeader(E.nss.requestHeader+"-CSS",E.load.css);z.setRequestHeader(E.nss.requestHeader+"-Script",E.load.script);f(E.callbacks.ajax.beforeSend,t,[C,E.parameter,z])},success:function(U,R,Q){H=U;A=R;z=Q;N(E.callbacks.ajax.success,t,[C,E.parameter,H,A,z]);UPDATE:{var N=fn.fire;if(N(E.callbacks.update.before,t,[C,E.parameter,H,A,z])===false){break UPDATE}try{if(z.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var X=jQuery(H).filter("title").text(),T=d(H,"css",'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)'),W=d(H,"script","([^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?<\/script>)([^'\"]|s*$)"),K=E.area.split(","),Z=E.scrollLeft===null?jQuery(w).scrollLeft():parseInt(E.scrollLeft),Y=E.scrollTop===null?jQuery(w).scrollTop():parseInt(E.scrollTop);if(!jQuery(E.area).length||!jQuery(E.area,H).add(jQuery(H).filter(E.area)).length){throw new Error()}UPDATE_URL:{if(N(E.callbacks.update.url.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_URL}x=x.replace(new RegExp("[?&]"+E.server.query+"=.*?([sW#&]|$)"),"");r?history.pushState(null,w.opera||("userAgent" in w&&userAgent.indexOf("opera")!==-1)?X:I.title,x):null;if(N(E.callbacks.update.url.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_URL}}UPDATE_TITLE:{if(N(E.callbacks.update.title.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_TITLE}I.title=X;if(N(E.callbacks.update.title.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(N(E.callbacks.update.content.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_CONTENT}for(var P=0,M;M=K[P];P++){try{jQuery(M).html(jQuery(M,H).add(jQuery(H).filter(M)).html());E.load.sync?jQuery(M).append(jQuery("<div/>",{"data-pjax-loaded":"true",style:"display:none;"})):null}catch(O){}}if(N(E.callbacks.update.content.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_CONTENT}}function S(){var ac=fn.filter;UPDATE_CSS:{if(!E.load.css){break UPDATE_CSS}if(N(E.callbacks.update.css.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,E.nss.data,true)});for(var ab=0,aa,ad;aa=T[ab];ab++){aa=jQuery(aa)[0];ad=false;LINK:{if(aa.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(ad||this.href!==aa.href){return false}ad=true;jQuery.data(this,E.nss.data)?jQuery.data(this,E.nss.data,false):null;return true}).length){continue}}STYLE:{if(aa.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(ad||!jQuery.data(this,E.nss.data)||this.innerHTML!==aa.innerHTML){return false}ad=true;jQuery.data(this,E.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(aa).children(":last-child").get(0),E.nss.data,false);aa=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,E.nss.data)}).remove();if(N(E.callbacks.update.css.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_CSS}}}E.load.sync?null:E.load.async.css===false?S():setTimeout(function(){S()},E.load.async.css);function V(){var ac=fn.filter;UPDATE_SCRIPT:{if(!E.load.script){break UPDATE_SCRIPT}if(N(E.callbacks.update.script.before,t,[C,E.parameter,H,A,z])===false){break UPDATE_SCRIPT}for(var ab=0,aa,ad;aa=W[ab];ab++){aa=jQuery(aa)[0];ad=false;if(jQuery("script[src]").filter(function(){if(ad||this.src!==aa.src){return false}ad=true;return true}).length){continue}jQuery.data(jQuery("head").append(aa).children(":last-child").get(0),E.nss.data,false);aa=null}if(N(E.callbacks.update.script.after,t,[C,E.parameter,H,A,z])===false){break UPDATE_SCRIPT}}}E.load.sync?null:E.load.async.script===false?V():setTimeout(function(){V()},E.load.async.script);if(E.load.sync){var L=setTimeout(function(){while(L=E.queue.shift()){clearTimeout(L)}if(jQuery(E.area).length===jQuery(E.area).children("div[data-pjax-loaded]").length){jQuery(E.area).children("div[data-pjax-loaded]").remove();S();V()}else{L=setTimeout(arguments.callee,E.interval);E.queue.push(L)}c[E.id]=E},E.interval);E.queue.push(L);c[E.id]=E}r&&-1<"click,submit".indexOf(C.type.toLowerCase())?w.scrollTo(Z,Y):null;if(N(E.callbacks.update.success,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callbacks.update.complete,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callback,t,[C,E.parameter,H,A,z])===false){break UPDATE}}catch(O){if(N(E.callbacks.update.error,t,[C,E.parameter,H,A,z])===false){break UPDATE}if(N(E.callbacks.update.complete,t,[C,E.parameter,H,A,z])===false){break UPDATE}E.fallback?j(C,t):null}if(N(E.callbacks.update.after,t,[C,E.parameter,H,A,z])===false){break UPDATE}H=null;A=null;z=null;s=null;F=null}},error:function(M,L,K){z=M;s=L;F=K;f(E.callbacks.ajax.error,t,[C,E.parameter,z,s,F]);E.fallback?j(C,t):null}}))}}function f(t,s,r){if(typeof t==="function"){return t.apply(s,r)}}function i(s){var r=jQuery.Deferred();if(!s){return r.resolve({fire:f,filter:d})}setTimeout(function(){r.resolve({fire:f,filter:d})},s);return r.promise()}function j(t,r,s){if(t.type.toLowerCase()==="click"){location.href=r.href}else{if(t.type.toLowerCase()==="submit"){r.submit()}else{if(t.type.toLowerCase()==="popstate"){location.reload()}}}}function d(v,s,u){var t,r=[];t=new RegExp(u,"gim");v.replace(t,function(x,w,y){r.push(s==="script"?y:x)});return r}return this}})(jQuery);
