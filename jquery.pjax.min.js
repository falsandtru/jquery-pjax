/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.8.4
 * @updated 2013/04/21
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @Compressor Closure Compiler
 */
(function(){function r(r){function w(c,d,k,x,a,b){function u(h){a:if(a.speedcheck&&a.log.speed.name.push("update_start"),a.speedcheck&&a.log.speed.time.push(a.speed.now()-a.log.speed.fire),!1!==e(a.callbacks.update.before,c,[d,a.parameter,j,l,f])){try{if(!h&&-1===f.getResponseHeader("Content-Type").indexOf("text/html"))throw Error();var b,n,m;h&&!1!==e(a.callbacks.update.cache.load.before,c,[d,a.parameter,h])&&(f=h.XMLHttpRequest,j=f.responseText,l=h.dataType,b=h.title,n=h.css,m=h.script,e(a.callbacks.update.cache.load.after,
c,[d,a.parameter,h]));var v=jQuery(j),r=0<v.filter("title").length;b=b||r?v.filter("title").text():C(j,"<title>([^<]*)</title>");var w=a.area.split(","),y=null===a.scrollLeft?jQuery(p).scrollLeft():parseInt(a.scrollLeft),B=null===a.scrollTop?jQuery(p).scrollTop():parseInt(a.scrollTop);if(!jQuery(a.area).length||!v.find(a.area).add(v.filter(a.area)).length)throw Error();!1!==e(a.callbacks.update.url.before,c,[d,a.parameter,j,l,f])&&(k=k.replace(RegExp("[?&]"+a.server.query+"=.*?([sW#&]|$)"),""),x&&
p.history.pushState(null,p.opera||"userAgent"in p&&-1!==userAgent.indexOf("opera")?b:D.title,k),e(a.callbacks.update.url.after,c,[d,a.parameter,j,l,f]));!1!==e(a.callbacks.update.title.before,c,[d,a.parameter,j,l,f])&&(D.title=b,e(a.callbacks.update.title.after,c,[d,a.parameter,j,l,f]));if(!1!==e(a.callbacks.update.content.before,c,[d,a.parameter,j,l,f])){for(var q=0,z;z=w[q];q++)jQuery(z).html(v.find(z).add(v.filter(z)).html()),a.load.script&&a.load.sync&&jQuery(z).append(jQuery("<div/>",{"class":a.nss.class4html+
"-loaded",style:"display: block !important; visibility: hidden !important; width: auto !important; height: 0 !important; margin: 0 !important; padding: 0 !important; border: none !important; position: absolute !important; top: -9999px !important; left: -9999px !important; font-size: 12px !important; text-indent: 0 !important;"}).text("pjax"));e(a.callbacks.update.content.after,c,[d,a.parameter,j,l,f])}a.load.css&&setTimeout(function(){if(!1!==e(a.callbacks.update.css.before,c,[d,a.parameter,j,l,f])){n=
n?n:r?v.find('link[rel="stylesheet"], style').add(v.filter('link[rel="stylesheet"], style')):C(j,'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)');t[a.id].history.data[k].css=n;jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,a.nss.data,!0)});for(var g=0,b,h;b=n[g];g++){h=!1;b=r?b:jQuery(b)[0];if("LINK"===b.tagName.toUpperCase()&&jQuery('link[rel="stylesheet"]').filter(function(){if(h||this.href!==b.href)return!1;h=!0;jQuery.data(this,a.nss.data)&&
jQuery.data(this,a.nss.data,!1);return!0}).length)continue;if("STYLE"===b.tagName.toUpperCase()&&jQuery("style").filter(function(){if(h||!jQuery.data(this,a.nss.data)||this.innerHTML!==b.innerHTML)return!1;h=!0;jQuery.data(this,a.nss.data,!1);return!0}).length)continue;jQuery.data(jQuery("head").append(b).children(":last-child")[0],a.nss.data,!1);b=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,a.nss.data)}).remove();!1!==e(a.callbacks.update.css.after,c,[d,
a.parameter,j,l,f])&&(a.speedcheck&&a.log.speed.name.push("css"),a.speedcheck&&a.log.speed.time.push(a.speed.now()-a.log.speed.fire))}},a.load.async||0);a.load.script&&setTimeout(function(){F("async")},a.load.async||0);var F=function(b){if(!1!==e(a.callbacks.update.script.before,c,[d,a.parameter,j,l,f])){m=m?m:r?v.find("script").add(v.filter("script")):C(j,"(?:[^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?\x3c/script>)(?:[^'\"]|s*$)");t[a.id].history.data[k].script=m;for(var g=0,h;h=m[g];g++)if(h=r?h:jQuery(h)[0],
"sync"!==b||h.defer)if(!("async"===b&&h.defer)&&(h.childNodes.length||!(h.src in a.log.script)))h.src.length&&(a.log.script[h.src]=!0),jQuery.data(jQuery("head").append(h).children(":last-child")[0],a.nss.data,!1);e(a.callbacks.update.script.after,c,[d,a.parameter,j,l,f])}};a.load.script&&a.load.sync&&setTimeout(function(){jQuery(a.area).length===jQuery(a.area).children("."+a.nss.class4html+"-loaded").filter(function(){return this.clientWidth}).length?(jQuery(a.area).children("."+a.nss.class4html+
"-loaded").remove(),setTimeout(function(){F("sync")},0),a.speedcheck&&a.log.speed.name.push("script"),a.speedcheck&&a.log.speed.time.push(a.speed.now()-a.log.speed.fire),a.speedcheck&&console.log(a.log.speed.time),a.speedcheck&&console.log(a.log.speed.name)):setTimeout(function(){arguments.callee()},a.interval)},0);x&&-1<"click,submit".indexOf(d.type.toLowerCase())&&p.scrollTo(y,B);if((a.cache.click||a.cache.submit||a.cache.popstate)&&"POST"!==a.ajax.type&&!1!==e(a.callbacks.update.cache.save.before,
c,[d,a.parameter,h])){var g=a.history,A;g.order.unshift(k);for(var q=1,s;s=g.order[q];q++)k===s&&g.order.splice(q,1);if(!h){A=2*j.length;g.size+=A;g.data[k]={data:null,dataType:l,XMLHttpRequest:f,title:b,size:A,timestamp:(new Date).getTime()};q=g.order.length-1;for(A=g.size;s=g.order[q];q--)if(q>=a.cache.length||g.size>a.cache.size||d.timeStamp>g.data[s].timestamp+a.cache.expire)g.order.pop(),g.size-=g.data[s].size,g.data[s]=null,delete g.data[s];a.history=g;e(a.callbacks.update.cache.save.after,
c,[d,a.parameter,h])}}t[a.id]=a;if(!1===e(a.callbacks.update.success,c,[d,a.parameter,j,l,f]))break a;if(!1===e(a.callbacks.update.complete,c,[d,a.parameter,j,l,f]))break a;if(!1===e(a.callback,c,[d,a.parameter,j,l,f]))break a}catch(G){if(h){g=a.history;g.order.unshift(k);for(q=1;s=g.order[q];q++)k===s&&g.order.splice(q,1);q=g.order.length-1;for(A=g.size;s=g.order[q];q--)if(q>=a.cache.length||g.size>a.cache.size||d.timeStamp>g.data[s].timestamp+a.cache.expire)g.order.pop(),g.size-=g.data[s].size,
g.data[s]=null,delete g.data[s];a.history=g}t[a.id]=a;if(!1===e(a.callbacks.update.error,c,[d,a.parameter,j,l,f]))break a;if(!1===e(a.callbacks.update.complete,c,[d,a.parameter,j,l,f]))break a;a.fallback&&E(d)}!1!==e(a.callbacks.update.after,c,[d,a.parameter,j,l,f])&&(a.speedcheck&&a.log.speed.name.push("end"),a.speedcheck&&a.log.speed.time.push(a.speed.now()-a.log.speed.fire))}}a.speedcheck&&(a.log.speed.fire=d.timeStamp);a.speedcheck&&(a.log.speed.time=[]);a.speedcheck&&(a.log.speed.name=[]);a.speedcheck&&
a.log.speed.name.push("fire");a.speedcheck&&a.log.speed.time.push(a.speed.now()-a.log.speed.fire);if(!1===e(a.callbacks.before,c,[d,a.parameter]))return c;if(b)jQuery.when?jQuery.when(B(a.wait)).done(function(){u(b)}):u(b);else{var j,l,f,n,m,r=[],y={dataFilter:function(h,b){j=h;l=b;return e(a.callbacks.ajax.dataFilter,c,[d,a.parameter,j,l])},complete:function(b,k){f=b;n=k;e(a.callbacks.ajax.complete,c,[d,a.parameter,f,n])}},w;for(w in y)w in a.callbacks.ajax||delete y[w];if("popstate"===d.type.toLowerCase()){if((r=
k.match(/\?[^\s]*/))&&"?"!==r[0])a.ajax.type="GET";a.ajax.data=null}"submit"===d.type.toLowerCase()&&(k=k.replace(/\?[^\s]*/,""),a.ajax.type=jQuery(d.target).attr("method").toUpperCase(),"GET"===a.ajax.type&&(k+="?"+jQuery(d.target).serialize(),a.ajax.data=null),"POST"===a.ajax.type&&(a.ajax.data=jQuery(d.target).serializeArray()));a.server.query&&(k=k.replace(/(#[^\s]*|)$/,(!k.match(/\?/)?"?":"&")+encodeURIComponent(a.server.query)+"=1$1"));a.speedcheck&&a.log.speed.name.push("ajax_start");a.speedcheck&&
a.log.speed.time.push(a.speed.now()-a.log.speed.fire);jQuery.when?jQuery.when(B(a.wait),jQuery.ajax(jQuery.extend(!0,{},a.ajax,y,{url:k,beforeSend:function(b){f=b;f.setRequestHeader(a.nss.requestHeader,"true");f.setRequestHeader(a.nss.requestHeader+"-Area",a.area);f.setRequestHeader(a.nss.requestHeader+"-CSS",a.load.css);f.setRequestHeader(a.nss.requestHeader+"-Script",a.load.script);e(a.callbacks.ajax.beforeSend,c,[d,a.parameter,f])},success:function(b,k,x){j=b;l=k;f=x;e(a.callbacks.ajax.success,
c,[d,a.parameter,j,l,f])},error:function(b,k,j){f=b;n=k;m=j;e(a.callbacks.ajax.error,c,[d,a.parameter,f,n,m]);a.fallback&&E(d)}}))).done(function(){u()}).fail().always():jQuery.ajax(jQuery.extend(!0,{},a.ajax,y,{url:k,beforeSend:function(b){f=b;f.setRequestHeader(a.nss.requestHeader,"true");f.setRequestHeader(a.nss.requestHeader+"-Area",a.area);f.setRequestHeader(a.nss.requestHeader+"-CSS",a.load.css);f.setRequestHeader(a.nss.requestHeader+"-Script",a.load.script);e(a.callbacks.ajax.beforeSend,c,
[d,a.parameter,f])},success:function(b,k,x){j=b;l=k;f=x;e(a.callbacks.ajax.success,c,[d,a.parameter,j,l,f]);u()},error:function(b,k,j){f=b;n=k;m=j;e(a.callbacks.ajax.error,c,[d,a.parameter,f,n,m]);a.fallback&&E(d)}}));if(!1===e(a.callbacks.after,c,[d,a.parameter]))return c}}function e(c,d,b){if("function"===typeof c)return c.apply(d,b)}function B(c){var d=jQuery.Deferred();if(!c)return d.resolve();setTimeout(function(){d.resolve()},c);return d.promise()}function E(c){"click"===c.type.toLowerCase()?
p.location.href=c.currentTarget.href:"submit"===c.type.toLowerCase()?context.submit():"popstate"===c.type.toLowerCase()&&p.location.reload()}function C(c,d){var b=[];c.replace(RegExp(d,"gim"),function(c,a){b.push(a)});return b}if("function"===typeof this)return arguments.callee.apply(jQuery(D),arguments);var u=jQuery.extend(!0,{},{id:0,gns:"pjax",ns:n,area:n,link:'a:not([target])[href^="/"]',form:n,scrollTop:0,scrollLeft:0,ajax:{},cache:{click:!1,submit:!1,popstate:!1,length:9,size:1048576,expire:18E5},
callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{},cache:{load:{},save:{}}}},parameter:n,load:{css:!1,script:!1,sync:!0,async:0},interval:300,wait:0,fallback:!0,delay:500,server:{query:""},speedcheck:!1},r),m=[u.gns].concat(u.ns||[]);jQuery.extend(!0,u,{nss:{pjax:m.join("."),click:["click"].concat(m.join(":")).join("."),submit:["submit"].concat(m.join(":")).join("."),popstate:["popstate"].concat(m.join(":")).join("."),data:m.join(":"),class4html:m.join("-"),
requestHeader:["X",m[0].replace(/^\w/,function(c){return c.toUpperCase()})].join("-")},server:{query:u.server.query.length?u.server.query:u.gns},log:{script:{},speed:{}},history:{order:[],data:{},size:0},timestamp:(new Date).getTime(),speed:{now:function(){return(new Date).getTime()}}});if(!(!("pushState"in p.history&&null!==p.history.pushState)?0:jQuery(u.area).length))return this;var b=u;b.id=t.length;t.push(b);b.link&&(b.form||jQuery(this).undelegate(b.link,b.nss.click).delegate(b.link,b.nss.click,
b.id,function(c){c.timeStamp=(new Date).getTime();if(1<c.which||(c.metaKey||c.ctrlKey||c.shiftKey||c.altKey)||(p.location.protocol!==this.protocol||p.location.host!==this.host)||p.location.pathname===this.pathname&&p.location.search===this.search&&p.location.hash!==this.hash)return this;var d,b,e;d=t[c.data];b=this.href;d.cache[c.type.toLowerCase()]&&(e=d.history.data[b]);e&&c.timeStamp>e.timestamp+d.cache.expire&&(e=n);w(this,c,b,b!==p.location.href,t[c.data],e);c.preventDefault()}));b.form&&jQuery(this).undelegate(b.form,
b.nss.submit).delegate(b.form,b.nss.submit,b.id,function(c){c.timeStamp=(new Date).getTime();var d,b,e;d=t[c.data];b=jQuery(c.target).attr("action");d.cache[c.type.toLowerCase()]&&(e=d.history.data[b]);e&&c.timeStamp>e.timestamp+d.cache.expire&&(e=n);w(this,c,b,!0,t[c.data],e);c.preventDefault()});jQuery(p).unbind(b.nss.popstate).bind(b.nss.popstate,b.id,function(c){c.timeStamp=(new Date).getTime();var b,e,m;b=t[c.data];e=p.location.href;b.cache[c.type.toLowerCase()]&&(m=b.history.data[e]);m&&c.timeStamp>
m.timestamp+b.cache.expire&&(m=n);!1!==b.timestamp&&b.delay>c.timeStamp-b.timestamp?(b.timestamp=!1,t[b.id]=b):(w(this,c,e,!1,t[c.data],m),c.preventDefault())});jQuery("script[src]").each(function(){this.src in b.log.script||(b.log.script[this.src]=!0)});return this}if("undefined"!==typeof window.jQuery){jQuery=window.jQuery;var n=void 0,p=window,D=document,t=["settings"];jQuery.fn.pjax=r;jQuery.pjax=r;r=null}})();
