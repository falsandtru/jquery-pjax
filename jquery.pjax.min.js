/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.6.4
 * @updated 2013/04/07
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @CodingConventions Google JavaScript Style Guide
 * @Compressor YUI Compressor
 */
(function(b){jQuery.fn.pjax=a;jQuery.pjax=a;a=null;function a(o){if(typeof this==="function"){return arguments.callee.apply(jQuery(document),arguments)}var j=window,l=document,g={gns:"pjax",ns:undefined,area:undefined,link:'a:not([target])[href^="/"]',form:undefined,scrollTop:0,scrollLeft:0,ajax:{},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{}}},parameter:undefined,load:{css:false,script:false,async:{css:false,script:false}},wait:0,fallback:true,server:{query:"pjax"}},f=jQuery.extend(true,{},g,o);jQuery.extend(true,f,{nss:{click:["click",f.gns+(f.ns?":"+f.ns:"")].join("."),submit:["submit",f.gns+(f.ns?":"+f.ns:"")].join("."),popstate:["popstate",f.gns+(f.ns?":"+f.ns:"")].join("."),data:f.gns+(f.ns?":"+f.ns:""),requestHeader:["X",f.gns.replace(/^(\w)/,function(p){return p.toUpperCase()})].join("-")}});if(!d()){return this}m(this,f);function d(){if(!n()){return false}if(!jQuery(f.area).length){return false}return true}function n(){return"pushState" in j.history&&j.history.pushState!==null}function m(p,q){DELEGATE_CLICK:{if(!q.link){break DELEGATE_CLICK}if(q.form){break DELEGATE_CLICK}jQuery(p).undelegate(q.link,q.nss.click).delegate(q.link,q.nss.click,q,function(r){if(r.which>1||r.metaKey||r.ctrlKey||r.shiftKey||r.altKey){return this}if(location.protocol!==this.protocol||location.host!==this.host){return this}if(location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash){return this}k(this,r,this.href,location.href!==this.href,r.data)})}DELEGATE_SUBMIT:{if(!q.form){break DELEGATE_SUBMIT}jQuery(p).undelegate(q.form,q.nss.submit).delegate(q.form,q.nss.submit,q,function(r){k(this,r,jQuery(r.target).attr("action"),true,r.data)})}BIND_POPSTATE:{setTimeout(function(){jQuery(j).unbind(q.nss.popstate).bind(q.nss.popstate,q,function(r){k(this,r,location.href,false,r.data)})},100)}}function k(r,A,v,p,C){var u=window,G=document,F,y,x,q,D,H,w=[],s=[],E={dataFilter:function(J,I){F=J;y=I;return e(C.callbacks.ajax.dataFilter,r,[A,C.parameter,F,y])},complete:function(J,I){x=J;q=I;e(C.callbacks.ajax.complete,r,[A,C.parameter,x,q])}};for(var B in E){if(B in C.callbacks.ajax){continue}delete E[B]}POPSTATE:{if(A.type.toLowerCase()!=="popstate"){break POPSTATE}GET:{w=v.match(/\?[^\s]*/);if(!w||w[0]==="?"){break GET}C.ajax.type="GET"}C.ajax.data=null}SUBMIT:{if(A.type.toLowerCase()!=="submit"){break SUBMIT}v=v.replace(/\?[^\s]*/,"");C.ajax.type=jQuery(A.target).attr("method").toUpperCase();GET:{if(C.ajax.type!=="GET"){break GET}v+="?"+jQuery(A.target).serialize();C.ajax.data=null}POST:{if(C.ajax.type!=="POST"){break POST}C.ajax.data=jQuery(A.target).serializeArray()}}URL:{if(!C.server.query){break URL}v=v.replace(/(#[^\s]*|)$/,(!v.match(/\?/)?"?":"&")+encodeURIComponent(C.server.query)+"=1$1")}if(e(C.callbacks.before,r,[A,C.parameter])===false){return r}switch(jQuery().jquery){case"1.0":case"1.0.4":case"1.1.0":case"1.1.2":case"1.1.3":case"1.1.4":case"1.2":case"1.2.3":case"1.2.6":case"1.3":case"1.4":case"1.4.1":case"1.4.2":case"1.4.3":case"1.4.4":t();break;case"1.5":case"1.5.1":case"1.5.2":case"1.6":case"1.6.1":case"1.6.2":case"1.6.3":case"1.6.4":case"1.7":case"1.7.1":case"1.7.2":case"1.8":case"1.8.1":case"1.8.2":case"1.8.3":case"1.9":case"1.9.1":default:z();break}if(e(C.callbacks.after,r,[A,C.parameter])===false){return r}A.preventDefault();function z(){jQuery.when(h(C.wait),jQuery.ajax(jQuery.extend(true,{},C.ajax,E,{url:v,beforeSend:function(I){x=I;x.setRequestHeader(C.nss.requestHeader,"true");x.setRequestHeader(C.nss.requestHeader+"-Area",C.area);x.setRequestHeader(C.nss.requestHeader+"-CSS",C.load.css);x.setRequestHeader(C.nss.requestHeader+"-Script",C.load.script);e(C.callbacks.ajax.beforeSend,r,[A,C.parameter,x])},success:function(K,J,I){F=K;y=J;x=I;e(C.callbacks.ajax.success,r,[A,C.parameter,F,y,x])},error:function(K,J,I){x=K;q=J;D=I;e(C.callbacks.ajax.error,r,[A,C.parameter,x,q,D]);C.fallback?i(A,r):null}}))).done(function(Q){UPDATE:{var K=Q.fire;if(K(C.callbacks.update.before,r,[A,C.parameter,F,y,x])===false){break UPDATE}try{if(x.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var S=jQuery(F).filter("title").text(),O=c(F,"css",'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)'),R=c(F,"script","([^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?<\/script>)([^'\"]|s*$)"),I=C.area.split(","),U=C.scrollLeft===null?jQuery(u).scrollLeft():parseInt(C.scrollLeft),T=C.scrollTop===null?jQuery(u).scrollTop():parseInt(C.scrollTop);if(!jQuery(C.area).length||!jQuery(C.area,F).add(jQuery(F).filter(C.area)).length){throw new Error()}UPDATE_URL:{if(K(C.callbacks.update.url.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_URL}v=v.replace(new RegExp("[?&]"+C.server.query+"=.*?([sW#&]|$)"),"");p?history.pushState(null,u.opera||("userAgent" in u&&userAgent.indexOf("opera")!==-1)?S:G.title,v):null;if(K(C.callbacks.update.url.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_URL}}UPDATE_TITLE:{if(K(C.callbacks.update.title.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_TITLE}G.title=S;if(K(C.callbacks.update.title.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(K(C.callbacks.update.content.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_CONTENT}for(var M=0,J;J=I[M];M++){try{jQuery(J).html(jQuery(J,F).add(jQuery(F).filter(J)).html())}catch(L){}}if(K(C.callbacks.update.content.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_CONTENT}}function N(){var X=Q.filter;UPDATE_CSS:{if(!C.load.css){break UPDATE_CSS}if(K(C.callbacks.update.css.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,C.nss.data,true)});for(var W=0,V,Y;V=O[W];W++){V=jQuery(V)[0];Y=false;LINK:{if(V.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(Y||this.href!==V.href){return false}Y=true;jQuery.data(this,C.nss.data)?jQuery.data(this,C.nss.data,false):null;return true}).length){continue}}STYLE:{if(V.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(Y||!jQuery.data(this,C.nss.data)||this.innerHTML!==V.innerHTML){return false}Y=true;jQuery.data(this,C.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(V).children(":last-child").get(0),C.nss.data,false);V=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,C.nss.data)}).remove();if(K(C.callbacks.update.css.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_CSS}}}C.load.async.css===false?N():setTimeout(function(){N()},C.load.async.css);function P(){var X=Q.filter;UPDATE_SCRIPT:{if(!C.load.script){break UPDATE_SCRIPT}if(K(C.callbacks.update.script.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_SCRIPT}for(var W=0,V,Y;V=R[W];W++){V=jQuery(V)[0];Y=false;if(jQuery("script[src]").filter(function(){if(Y||this.src!==V.src){return false}Y=true;return true}).length){continue}jQuery.data(jQuery("head").append(V).children(":last-child").get(0),C.nss.data,false);V=null}if(K(C.callbacks.update.script.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_SCRIPT}}}C.load.async.script===false?P():setTimeout(function(){P()},C.load.async.script);p&&-1<"click,submit".indexOf(A.type.toLowerCase())?u.scrollTo(U,T):null;if(K(C.callbacks.update.success,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callbacks.update.complete,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callback,r,[A,C.parameter,F,y,x])===false){break UPDATE}}catch(L){if(K(C.callbacks.update.error,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callbacks.update.complete,r,[A,C.parameter,F,y,x])===false){break UPDATE}C.fallback?i(A,r):null}if(K(C.callbacks.update.after,r,[A,C.parameter,F,y,x])===false){break UPDATE}F=null;y=null;x=null;q=null;D=null}}).fail().always()}function t(){jQuery.ajax(jQuery.extend(true,{},C.ajax,E,{url:v,beforeSend:function(I){x=I;x.setRequestHeader(C.nss.requestHeader,"true");x.setRequestHeader(C.nss.requestHeader+"-Area",C.area);x.setRequestHeader(C.nss.requestHeader+"-CSS",C.load.css);x.setRequestHeader(C.nss.requestHeader+"-Script",C.load.script);e(C.callbacks.ajax.beforeSend,r,[A,C.parameter,x])},success:function(R,O,N){F=R;y=O;x=N;K(C.callbacks.ajax.success,r,[A,C.parameter,F,y,x]);UPDATE:{var K=fn.fire;if(K(C.callbacks.update.before,r,[A,C.parameter,F,y,x])===false){break UPDATE}try{if(x.getResponseHeader("Content-Type").indexOf("text/html")===-1){throw new Error()}var U=jQuery(F).filter("title").text(),Q=c(F,"css",'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)'),T=c(F,"script","([^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?<\/script>)([^'\"]|s*$)"),I=C.area.split(","),W=C.scrollLeft===null?jQuery(u).scrollLeft():parseInt(C.scrollLeft),V=C.scrollTop===null?jQuery(u).scrollTop():parseInt(C.scrollTop);if(!jQuery(C.area).length||!jQuery(C.area,F).add(jQuery(F).filter(C.area)).length){throw new Error()}UPDATE_URL:{if(K(C.callbacks.update.url.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_URL}v=v.replace(new RegExp("[?&]"+C.server.query+"=.*?([sW#&]|$)"),"");p?history.pushState(null,u.opera||("userAgent" in u&&userAgent.indexOf("opera")!==-1)?U:G.title,v):null;if(K(C.callbacks.update.url.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_URL}}UPDATE_TITLE:{if(K(C.callbacks.update.title.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_TITLE}G.title=U;if(K(C.callbacks.update.title.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_TITLE}}UPDATE_CONTENT:{if(K(C.callbacks.update.content.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_CONTENT}for(var M=0,J;J=I[M];M++){try{jQuery(J).html(jQuery(J,F).add(jQuery(F).filter(J)).html())}catch(L){}}if(K(C.callbacks.update.content.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_CONTENT}}function P(){var Z=fn.filter;UPDATE_CSS:{if(!C.load.css){break UPDATE_CSS}if(K(C.callbacks.update.css.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_CSS}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,C.nss.data,true)});for(var Y=0,X,aa;X=Q[Y];Y++){X=jQuery(X)[0];aa=false;LINK:{if(X.tagName.toUpperCase()!=="LINK"){break LINK}if(jQuery('link[rel="stylesheet"]').filter(function(){if(aa||this.href!==X.href){return false}aa=true;jQuery.data(this,C.nss.data)?jQuery.data(this,C.nss.data,false):null;return true}).length){continue}}STYLE:{if(X.tagName.toUpperCase()!=="STYLE"){break STYLE}if(jQuery("style").filter(function(){if(aa||!jQuery.data(this,C.nss.data)||this.innerHTML!==X.innerHTML){return false}aa=true;jQuery.data(this,C.nss.data,false);return true}).length){continue}}jQuery.data(jQuery("head").append(X).children(":last-child").get(0),C.nss.data,false);X=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,C.nss.data)}).remove();if(K(C.callbacks.update.css.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_CSS}}}C.load.async.css===false?P():setTimeout(function(){P()},C.load.async.css);function S(){var Z=fn.filter;UPDATE_SCRIPT:{if(!C.load.script){break UPDATE_SCRIPT}if(K(C.callbacks.update.script.before,r,[A,C.parameter,F,y,x])===false){break UPDATE_SCRIPT}for(var Y=0,X,aa;X=T[Y];Y++){X=jQuery(X)[0];aa=false;if(jQuery("script[src]").filter(function(){if(aa||this.src!==X.src){return false}aa=true;return true}).length){continue}jQuery.data(jQuery("head").append(X).children(":last-child").get(0),C.nss.data,false);X=null}if(K(C.callbacks.update.script.after,r,[A,C.parameter,F,y,x])===false){break UPDATE_SCRIPT}}}C.load.async.script===false?S():setTimeout(function(){S()},C.load.async.script);p&&-1<"click,submit".indexOf(A.type.toLowerCase())?u.scrollTo(W,V):null;if(K(C.callbacks.update.success,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callbacks.update.complete,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callback,r,[A,C.parameter,F,y,x])===false){break UPDATE}}catch(L){if(K(C.callbacks.update.error,r,[A,C.parameter,F,y,x])===false){break UPDATE}if(K(C.callbacks.update.complete,r,[A,C.parameter,F,y,x])===false){break UPDATE}C.fallback?i(A,r):null}if(K(C.callbacks.update.after,r,[A,C.parameter,F,y,x])===false){break UPDATE}F=null;y=null;x=null;q=null;D=null}},error:function(K,J,I){x=K;q=J;D=I;e(C.callbacks.ajax.error,r,[A,C.parameter,x,q,D]);C.fallback?i(A,r):null}}))}}function e(r,q,p){if(typeof r==="function"){return r.apply(q,p)}}function h(q){var p=jQuery.Deferred();if(!q){return p.resolve({fire:e,filter:c})}setTimeout(function(){p.resolve({fire:e,filter:c})},q);return p.promise()}function i(r,p,q){if(r.type.toLowerCase()==="click"){location.href=p.href}else{if(r.type.toLowerCase()==="submit"){p.submit()}else{if(r.type.toLowerCase()==="popstate"){location.reload()}}}}function c(t,q,s){var r,p=[];r=new RegExp(s,"gim");t.replace(r,function(v,u,w){p.push(q==="script"?w:v)});return p}return this}})(jQuery);
