/*
 * 
 * pjax
 * 
 * ---
 * @Copyright(c) 2012, falsandtru
 * @license MIT  http://opensource.org/licenses/mit-license.php  http://sourceforge.jp/projects/opensource/wiki/licenses%2FMIT_license
 * @version 1.8.0
 * @updated 2013/04/17
 * @author falsandtru  http://fat.main.jp/  http://sa-kusaku.sakura.ne.jp/
 * @Compressor Closure Compiler
 */
(function(){function s(s){function q(j,c,b,h,a,m){function s(k){a:if(a.speed.check?a.speed.log.name.push("update_start"):null,a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null,!1!==e(a.callbacks.update.before,j,[c,a.parameter,g,l,f])){try{if(!k&&-1===f.getResponseHeader("Content-Type").indexOf("text/html"))throw Error();var w,x,m;!1!==e(a.callbacks.update.cache.before,j,[c,a.parameter,k])&&(k&&(f=k.XMLHttpRequest,g=f.responseText,l=k.dataType,w=k.title,x=k.css,m=k.script,c=
k.event),e(a.callbacks.update.cache.after,j,[c,a.parameter,k]));var t=jQuery(g),q=0<t.filter("title").length;w=w?w:q?t.filter("title").text():D(g,"<title>([^<]*)</title>");var v=a.area.split(","),y=null===a.scrollLeft?jQuery(u).scrollLeft():parseInt(a.scrollLeft),z=null===a.scrollTop?jQuery(u).scrollTop():parseInt(a.scrollTop);if(!jQuery(a.area).length||!t.find(a.area).add(t.filter(a.area)).length)throw Error();!1!==e(a.callbacks.update.url.before,j,[c,a.parameter,g,l,f])&&(b=b.replace(RegExp("[?&]"+
a.server.query+"=.*?([sW#&]|$)"),""),h?history.pushState(null,u.opera||"userAgent"in u&&-1!==userAgent.indexOf("opera")?w:E.title,b):null,e(a.callbacks.update.url.after,j,[c,a.parameter,g,l,f]));!1!==e(a.callbacks.update.title.before,j,[c,a.parameter,g,l,f])&&(E.title=w,e(a.callbacks.update.title.after,j,[c,a.parameter,g,l,f]));if(!1!==e(a.callbacks.update.content.before,j,[c,a.parameter,g,l,f])){for(var n=0,B;B=v[n];n++)jQuery(B).html(t.find(B).add(t.filter(B)).html()),a.load.script&&a.load.sync?
jQuery(B).append(jQuery("<div/>",{"class":a.nss.class4html+"-loaded",style:"display: block !important; visibility: hidden !important; width: auto !important; height: 0 !important; margin: 0 !important; padding: 0 !important; border: none !important; position: absolute !important; top: -9999px !important; left: -9999px !important; font-size: 12px !important; text-indent: 0 !important;"}).text("pjax")):null;e(a.callbacks.update.content.after,j,[c,a.parameter,g,l,f])}a.load.css?setTimeout(function(){if(!1!==
e(a.callbacks.update.css.before,j,[c,a.parameter,g,l,f])){x=x?x:q?t.find('link[rel="stylesheet"], style').add(t.filter('link[rel="stylesheet"], style')):D(g,'(<link[^>]*?rel="stylesheet"[^>]*?>|<style[^>]*?>(.|[\n\r])*?</style>)');jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,a.nss.data,!0)});for(var b=0,d,k;d=x[b];b++){k=!1;d=q?d:jQuery(d)[0];if("LINK"===d.tagName.toUpperCase()&&jQuery('link[rel="stylesheet"]').filter(function(){if(k||this.href!==d.href)return!1;
k=!0;jQuery.data(this,a.nss.data)?jQuery.data(this,a.nss.data,!1):null;return!0}).length)continue;if("STYLE"===d.tagName.toUpperCase()&&jQuery("style").filter(function(){if(k||!jQuery.data(this,a.nss.data)||this.innerHTML!==d.innerHTML)return!1;k=!0;jQuery.data(this,a.nss.data,!1);return!0}).length)continue;jQuery.data(jQuery("head").append(d).children(":last-child")[0],a.nss.data,!1);d=null}jQuery('link[rel="stylesheet"], style').filter(function(){return jQuery.data(this,a.nss.data)}).remove();!1!==
e(a.callbacks.update.css.after,j,[c,a.parameter,g,l,f])&&(a.speed.check?a.speed.log.name.push("css"):null,a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null)}},a.load.async||0):null;a.load.script?setTimeout(function(){A("async")},a.load.async||0):null;var A=function(b){if(!1!==e(a.callbacks.update.script.before,j,[c,a.parameter,g,l,f])){m=m?m:q?t.find("script").add(t.filter("script")):D(g,"(?:[^'\"]|^s*)(<script[^>]*?>(.|[\n\r])*?\x3c/script>)(?:[^'\"]|s*$)");for(var d=0,k,h;k=
m[d];d++)if(h=!1,k=q?k:jQuery(k)[0],!a.load.sync||"sync"!==b||k.defer)if((!a.load.sync||!("async"===b&&k.defer))&&!jQuery("script[src]").filter(function(){return h||this.src!==k.src?!1:h=!0}).length)jQuery.data(jQuery("head").append(k).children(":last-child")[0],a.nss.data,!1),k=null;e(a.callbacks.update.script.after,j,[c,a.parameter,g,l,f])}};a.load.script&&a.load.sync&&setTimeout(function(){jQuery(a.area).length===jQuery(a.area).children("."+a.nss.class4html+"-loaded").filter(function(){return this.clientWidth}).length?
(jQuery(a.area).children("."+a.nss.class4html+"-loaded").remove(),setTimeout(function(){A("sync")},0),a.speed.check?a.speed.log.name.push("script"):null,a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null,a.speed.check?console.log(a.speed.log.time):null,a.speed.check?console.log(a.speed.log.name):null,a.speed.check?console.log(a.speed.log.retry):null):(setTimeout(function(){arguments.callee()},a.interval),a.speed.check?++a.speed.log.retry:null)},0);h&&-1<"click,submit".indexOf(c.type.toLowerCase())?
u.scrollTo(y,z):null;if(a.cache[c.type.toLowerCase()]&&"POST"!==a.ajax.type){var d=a.history,C;d.order.unshift(b);for(var n=1,p;p=d.order[n];n++)b===p&&d.order.splice(n,1);if(!k){C=2*g.length;d.size+=C;d.data[b]={event:c,data:null,dataType:l,XMLHttpRequest:f,title:w,css:x,script:m,size:C,timestamp:(new Date).getTime()};n=d.order.length-1;for(C=d.size;p=d.order[n];n--)if(n>=a.cache.length||d.size>a.cache.size||c.timeStamp>d.data[p].timestamp+a.cache.expire)d.order.pop(),d.size-=d.data[p].size,d.data[p]=
null,delete d.data[p];a.history=d}}r[a.id]=a;if(!1===e(a.callbacks.update.success,j,[c,a.parameter,g,l,f]))break a;if(!1===e(a.callbacks.update.complete,j,[c,a.parameter,g,l,f]))break a;if(!1===e(a.callback,j,[c,a.parameter,g,l,f]))break a}catch(G){if(k){d=a.history;d.order.unshift(b);for(n=1;p=d.order[n];n++)b===p&&d.order.splice(n,1);n=d.order.length-1;for(C=d.size;p=d.order[n];n--)if(n>=a.cache.length||d.size>a.cache.size||c.timeStamp>d.data[p].timestamp+a.cache.expire)d.order.pop(),d.size-=d.data[p].size,
d.data[p]=null,delete d.data[p];a.history=d}r[a.id]=a;if(!1===e(a.callbacks.update.error,j,[c,a.parameter,g,l,f]))break a;if(!1===e(a.callbacks.update.complete,j,[c,a.parameter,g,l,f]))break a;a.fallback?F(c):null}!1!==e(a.callbacks.update.after,j,[c,a.parameter,g,l,f])&&(a.speed.check?a.speed.log.name.push("end"):null,a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null)}}a.speed.check?a.speed.log.fire=c.timeStamp:null;a.speed.check?a.speed.log.time=[]:null;a.speed.check?a.speed.log.name=
[]:null;a.speed.check?a.speed.log.name.push("fire"):null;a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null;if(!1===e(a.callbacks.before,j,[c,a.parameter]))return j;if(m)jQuery.when?jQuery.when(G(a.wait)).done(function(){s(m)}):s(m);else{var g,l,f,v,y,q=[],z={dataFilter:function(b,f){g=b;l=f;return e(a.callbacks.ajax.dataFilter,j,[c,a.parameter,g,l])},complete:function(b,g){f=b;v=g;e(a.callbacks.ajax.complete,j,[c,a.parameter,f,v])}},A;for(A in z)A in a.callbacks.ajax||delete z[A];
if("popstate"===c.type.toLowerCase()){if((q=b.match(/\?[^\s]*/))&&"?"!==q[0])a.ajax.type="GET";a.ajax.data=null}"submit"===c.type.toLowerCase()&&(b=b.replace(/\?[^\s]*/,""),a.ajax.type=jQuery(c.target).attr("method").toUpperCase(),"GET"===a.ajax.type&&(b+="?"+jQuery(c.target).serialize(),a.ajax.data=null),"POST"===a.ajax.type&&(a.ajax.data=jQuery(c.target).serializeArray()));a.server.query&&(b=b.replace(/(#[^\s]*|)$/,(!b.match(/\?/)?"?":"&")+encodeURIComponent(a.server.query)+"=1$1"));a.speed.check?
a.speed.log.name.push("ajax_start"):null;a.speed.check?a.speed.log.time.push(a.speed.now()-a.speed.log.fire):null;jQuery.when?jQuery.when(G(a.wait),jQuery.ajax(jQuery.extend(!0,{},a.ajax,z,{url:b,beforeSend:function(b){f=b;f.setRequestHeader(a.nss.requestHeader,"true");f.setRequestHeader(a.nss.requestHeader+"-Area",a.area);f.setRequestHeader(a.nss.requestHeader+"-CSS",a.load.css);f.setRequestHeader(a.nss.requestHeader+"-Script",a.load.script);e(a.callbacks.ajax.beforeSend,j,[c,a.parameter,f])},success:function(b,
h,m){g=b;l=h;f=m;e(a.callbacks.ajax.success,j,[c,a.parameter,g,l,f])},error:function(b,g,h){f=b;v=g;y=h;e(a.callbacks.ajax.error,j,[c,a.parameter,f,v,y]);a.fallback?F(c):null}}))).done(function(){s()}).fail().always():jQuery.ajax(jQuery.extend(!0,{},a.ajax,z,{url:b,beforeSend:function(b){f=b;f.setRequestHeader(a.nss.requestHeader,"true");f.setRequestHeader(a.nss.requestHeader+"-Area",a.area);f.setRequestHeader(a.nss.requestHeader+"-CSS",a.load.css);f.setRequestHeader(a.nss.requestHeader+"-Script",
a.load.script);e(a.callbacks.ajax.beforeSend,j,[c,a.parameter,f])},success:function(b,h,m){g=b;l=h;f=m;e(a.callbacks.ajax.success,j,[c,a.parameter,g,l,f]);s()},error:function(b,g,h){f=b;v=g;y=h;e(a.callbacks.ajax.error,j,[c,a.parameter,f,v,y]);a.fallback?F(c):null}}));if(!1===e(a.callbacks.after,j,[c,a.parameter]))return j}}function e(b,c,e){if("function"===typeof b)return b.apply(c,e)}function G(b){var c=jQuery.Deferred();if(!b)return c.resolve();setTimeout(function(){c.resolve()},b);return c.promise()}
function F(b){"click"===b.type.toLowerCase()?location.href=b.currentTarget.href:"submit"===b.type.toLowerCase()?context.submit():"popstate"===b.type.toLowerCase()&&location.reload()}function D(b,c){var e=[];b.replace(RegExp(c,"gim"),function(b,a){e.push(a)});return e}if("function"===typeof this)return arguments.callee.apply(jQuery(E),arguments);var b=jQuery.extend(!0,{},{id:0,gns:"pjax",ns:m,area:m,link:'a:not([target])[href^="/"]',form:m,scrollTop:0,scrollLeft:0,ajax:{},cache:{click:!0,submit:!0,
popstate:!0,length:9,size:1048576,expire:18E5},callback:function(){},callbacks:{ajax:{},update:{url:{},title:{},content:{},css:{},script:{},cache:{}}},parameter:m,load:{css:!1,script:!1,sync:!0,async:0},interval:300,wait:0,fallback:!0,server:{query:"pjax"},delay:500,speed:{check:!1}},s);jQuery.extend(!0,b,{nss:{class4html:""+(b.gns+(b.ns?"-"+b.ns:"")),click:["click",b.gns+(b.ns?":"+b.ns:"")].join("."),submit:["submit",b.gns+(b.ns?":"+b.ns:"")].join("."),popstate:["popstate",b.gns+(b.ns?":"+b.ns:"")].join("."),
data:b.gns+(b.ns?":"+b.ns:""),requestHeader:["X",b.gns.replace(/^(\w)/,function(b){return b.toUpperCase()})].join("-")},history:{order:[],data:{},size:0},timestamp:(new Date).getTime(),speed:{now:function(){return(new Date).getTime()},log:{retry:0}}});if(!(!("pushState"in u.history&&null!==u.history.pushState)?0:jQuery(b.area).length))return this;b.id=r.length;r.push(b);b.link&&(b.form||jQuery(this).undelegate(b.link,b.nss.click).delegate(b.link,b.nss.click,b.id,function(b){if(1<b.which||(b.metaKey||
b.ctrlKey||b.shiftKey||b.altKey)||(location.protocol!==this.protocol||location.host!==this.host)||location.pathname===this.pathname&&location.search===this.search&&location.hash!==this.hash)return this;var c,e,h;c=r[b.data];e=this.href;c.cache[b.type.toLowerCase()]&&(h=c.history.data[e]);h&&b.timeStamp>h.timestamp+c.cache.expire&&(h=m);q(this,b,e,e!==location.href,r[b.data],h);b.preventDefault()}));b.form&&jQuery(this).undelegate(b.form,b.nss.submit).delegate(b.form,b.nss.submit,b.id,function(b){var c,
e,h;c=r[b.data];e=jQuery(b.target).attr("action");c.cache[b.type.toLowerCase()]&&(h=c.history.data[e]);h&&b.timeStamp>h.timestamp+c.cache.expire&&(h=m);q(this,b,e,!0,r[b.data],h);b.preventDefault()});jQuery(u).unbind(b.nss.popstate).bind(b.nss.popstate,b.id,function(b){var c,e,h;c=r[b.data];e=location.href;c.cache[b.type.toLowerCase()]&&(h=c.history.data[e]);h&&b.timeStamp>h.timestamp+c.cache.expire&&(h=m);!1!==c.timestamp&&c.delay>b.timeStamp-c.timestamp?(c.timestamp=!1,r[c.id]=c):(q(this,b,e,!1,
r[b.data],h),b.preventDefault())});return this}if("undefined"!==typeof window.jQuery){jQuery=window.jQuery;var m=void 0,u=window,E=document,r=["settings"];jQuery.fn.pjax=s;jQuery.pjax=s;s=null}})();
